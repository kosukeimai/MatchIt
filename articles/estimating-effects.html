<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Estimating Effects After Matching • MatchIt</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Estimating Effects After Matching">
<meta property="og:description" content="MatchIt">
<meta property="og:image" content="https://kosukeimai.github.io/MatchIt/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">MatchIt</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">4.5.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/MatchIt.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/matching-methods.html">Matching Methods</a>
    </li>
    <li>
      <a href="../articles/assessing-balance.html">Assessing Balance</a>
    </li>
    <li>
      <a href="../articles/estimating-effects.html">Estimating Effects After Matching</a>
    </li>
    <li>
      <a href="../articles/sampling-weights.html">Matching with Sampling Weights</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/kosukeimai/MatchIt/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Estimating Effects After Matching</h1>
                        <h4 data-toc-skip class="author">Noah
Greifer</h4>
            
            <h4 data-toc-skip class="date">2022-11-23</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/kosukeimai/MatchIt/blob/HEAD/vignettes/estimating-effects.Rmd" class="external-link"><code>vignettes/estimating-effects.Rmd</code></a></small>
      <div class="hidden name"><code>estimating-effects.Rmd</code></div>

    </div>

    
    
<style>
pre {
  overflow-x: auto;
}
pre code {
  word-wrap: normal;
  white-space: pre;
}
</style>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>After assessing balance and deciding on a matching specification, it
comes time to estimate the effect of the treatment in the matched
sample. How the effect is estimated and interpreted depends on the
desired estimand and the type of model used (if any). In addition to
estimating effects, estimating the uncertainty of the effects is
critical in communicating them and assessing whether the observed effect
is compatible with there being no effect in the population. This guide
explains how to estimate effects after various forms of matching and
with various outcome types. There may be situations that are not covered
here for which additional methodological research may be required, but
some of the recommended methods here can be used to guide such
applications.</p>
<p>This guide is structured as follows: first, information on the
concepts related to effect and standard error (SE) estimation is
presented below. Then, instructions for how to estimate effects and SEs
are described for the standard case (matching for the ATT with a
continuous outcome) and some other common circumstances. Finally,
recommendations for reporting results and tips to avoid making common
mistakes are presented.</p>
<div class="section level3">
<h3 id="identifying-the-estimand">Identifying the estimand<a class="anchor" aria-label="anchor" href="#identifying-the-estimand"></a>
</h3>
<p>Before an effect is estimated, the estimand must be specified and
clarified. Although some aspects of the estimand depend not only on how
the effect is estimated after matching but also on the matching method
itself, other aspects must be considered at the time of effect
estimation and interpretation. Here, we consider three aspects of the
estimand: the population the effect is meant to generalize to (the
target population), the effect measure, and whether the effect is
marginal or conditional.</p>
<p><strong>The target population.</strong> Different matching methods
allow you to estimate effects that can generalize to different target
populations. The most common estimand in matching the average treatment
effect in the treated (ATT), which is the average effect of treatment
for those who receive treatment. This estimand is estimable for matching
methods that do not change the treated units (i.e., by weighting or
discarding units) and is requested in <code><a href="../reference/matchit.html">matchit()</a></code> by setting
<code>estimand = "ATT"</code> (which is the default). The average
treatment effect in the population (ATE) is the average effect of
treatment for the population from which the sample is a random sample.
This estimand is estimable only for methods that allow the ATE and
either do not discard units from the sample or explicit target full
sample balance, which in <code>MatchIt</code> is limited to full
matching, subclassification, and template matching when setting
<code>estimand = "ATE"</code>. When treated units are discarded (e.g.,
through the use of common support restrictions, calipers, cardinality
matching, or [coarsened] exact matching), the estimand corresponds to
neither the population ATT nor the population ATE, but rather to an
average treatment effect in the remaining matched sample (ATM), which
may not correspond to any specific target population. See <span class="citation">Greifer and Stuart (<a href="#ref-greiferChoosingEstimandWhen2021" role="doc-biblioref">2021</a>)</span> for a discussion on the
substantive considerations involved when choosing the target population
of the estimand.</p>
<p><strong>Marginal and conditional effects.</strong> A marginal effect
is a comparison between the expected potential outcome under treatment
and the expected potential outcome under control. This is the same
quantity estimated in randomized trials without blocking or covariate
adjustment and is particularly useful for quantifying the overall effect
of a policy or population-wide intervention. A conditional effect is the
comparison between the expected potential outcomes in the treatment
groups within strata. This is useful for identifying the effect of a
treatment for an individual patient or a subset of the population.</p>
<p><strong>Effect measures.</strong> The outcome types we consider here
are continuous, with the effect measured by the mean difference; binary,
with the effect measured by the risk difference (RD), risk ratio (RR),
or odds ratio (OR); and time-to-event (i.e., survival), with the effect
measured by the hazard ratio (HR). The RR, OR, and HR are
<em>noncollapsible</em> effect measures, which means the marginal effect
on that scale is not a (possibly) weighted average of the conditional
effects within strata, even if the stratum-specific effects are of the
same magnitude. For these effect measures, it is critical to distinguish
between marginal and conditional effects because different statistical
methods target different types of effects. The mean difference and RD
are <em>collapsible</em> effect measures, so the same methods can be
used to estimate marginal and conditional effects.</p>
<p>Our primary focus will be on marginal effects, which are appropriate
for all effect measures, easily interpretable, and require few modeling
assumptions. The “Common Mistakes” section includes examples of commonly
used methods that estimate conditional rather than marginal effects and
should not be used when marginal effects are desired.</p>
</div>
<div class="section level3">
<h3 id="g-computation">G-computation<a class="anchor" aria-label="anchor" href="#g-computation"></a>
</h3>
<p>To estimate marginal effects, we use a method known as g-computation
<span class="citation">(<a href="#ref-snowdenImplementationGComputationSimulated2011" role="doc-biblioref">Snowden, Rose, and Mortimer 2011</a>)</span> or
regression estimation <span class="citation">(<a href="#ref-schaferAverageCausalEffects2008" role="doc-biblioref">Schafer
and Kang 2008</a>)</span>. This involves first specifying a model for
the outcome as a function of the treatment and covariates. Then, for
each unit, we compute their predicted values of the outcome setting
their treatment status to treated, and then again for control, leaving
us with two predicted outcome values for each unit, which are estimates
of the potential outcomes under each treatment level. We compute the
mean of each of the estimated potential outcomes across the entire
sample, which leaves us with two average estimated potential outcomes.
Finally, the contrast of these average estimated potential outcomes
(e.g., their difference or ratio, depending on the effect measure
desired) is the estimate of the treatment effect.</p>
<p>When doing g-computation after matching, a few additional
considerations are required. First, when we take the average of the
estimated potential outcomes under each treatment level, this must be a
weighted average that incorporates the matching weights. Second, if we
want to target the ATT or ATC, we only estimate potential outcomes for
the treated or control group, respectively (though we still generate
predicted values under both treatment and control).</p>
<p>G-computation as a framework for estimating effects after matching
has a number of advantages over other approaches. It works the same
regardless of the form of the outcome model or type of outcome (e.g.,
whether a linear model is used for a continuous outcome or a logistic
model is used for a binary outcome); the only difference might be how
the average expected potential outcomes are contrasted in the final
step. In simple cases, the estimated effect is numerically identical to
effects estimated using other methods; for example, if no covariates are
included in the outcome model, the g-computation estimate is equal to
the difference in means from a t-test or coefficient of the treatment in
a linear model for the outcome. There are analytic approximations to the
SEs of the g-computation estimate, and these SEs can incorporate
pair/subclass membership (described in more detail below).</p>
<p>For all these reasons, we use g-computation when possible for all
effect estimates, even if there are simpler methods that would yield the
same estimates. Using a single workflow (with some slight modifications
depending on the context; see below) facilitates implementing best
practices regardless of what choices a user makes.</p>
</div>
<div class="section level3">
<h3 id="modeling-the-outcome">Modeling the Outcome<a class="anchor" aria-label="anchor" href="#modeling-the-outcome"></a>
</h3>
<p>The goal of the outcome model is to generate good predictions for use
in the g-computation procedure described above. The type and form of the
outcome model should depend on the outcome type. For continuous
outcomes, one can use a linear model regressing the outcome on the
treatment; for binary outcomes, one can use a generalized linear model
with, e.g., a logistic link; for time-to-event outcomes, one can use a
Cox proportional hazards model.</p>
<p>An additional decision to make is whether (and how) to include
covariates in the outcome model. One may ask, why use matching at all if
you are going to model the outcome with covariates anyway? Matching
reduces the dependence of the effect estimate on correct specification
of the outcome model; this is the central thesis of <span class="citation">Ho et al. (<a href="#ref-ho2007" role="doc-biblioref">2007</a>)</span>. Including covariates in the
outcome model after matching has several functions: it can increase
precision in the effect estimate, reduce the bias due to residual
imbalance, and make the effect estimate “doubly robust”, which means it
is consistent if either the matching reduces sufficient imbalance in the
covariates or if the outcome model is correct. For these reasons, we
recommend covariate adjustment after matching when possible. There is
some evidence that covariate adjustment is most helpful for covariates
with standardized mean differences greater than .1 <span class="citation">(<a href="#ref-nguyen2017" role="doc-biblioref">Nguyen
et al. 2017</a>)</span>, so these covariates and covariates thought to
be highly predictive of the outcome should be prioritized in treatment
effect models if not all can be included due to sample size
constraints.</p>
<p>Although there are many possible ways to include covariates (e.g.,
not just main effects but interactions, smoothing terms like splines, or
other nonlinear transformations), it is important not to engage in
specification search (i.e., trying many outcomes models in search of the
“best” one). Doing so can invalidate results and yield a conclusion that
fails to replicate. For this reason, we recommend only including the
same terms included in the propensity score model unless there is a
strong <em>a priori</em> and justifiable reason to model the outcome
differently.</p>
<p>It is important not to interpret the coefficients and tests of
covariates in the outcome model. These are not causal effects and their
estimates may be severely confounded. Only the treatment effect estimate
can be interpreted as causal assuming the relevant assumptions about
unconfoundedness are met. Inappropriately interpreting the coefficients
of covariates in the outcome model is known as the Table 2 fallacy <span class="citation">(<a href="#ref-westreich2013" role="doc-biblioref">Westreich and Greenland 2013</a>)</span>. To avoid
this, we only display the results of the g-computation procedure and do
not examine or interpret the outcome models themselves.</p>
</div>
<div class="section level3">
<h3 id="estimating-standard-errors-and-confidence-intervals">Estimating Standard Errors and Confidence Intervals<a class="anchor" aria-label="anchor" href="#estimating-standard-errors-and-confidence-intervals"></a>
</h3>
<p>Uncertainty estimation (i.e., of SEs, confidence intervals, and
p-values) may consider the variety of sources of uncertainty present in
the analysis, including (but not limited to!) estimation of the
propensity score (if used), matching (i.e., because treated units might
be matched to different control units if others had been sampled), and
estimation of the treatment effect (i.e., because of sampling error). In
general, there are no analytic solutions to all these issues, so much of
the research done on uncertainty estimation after matching has relied on
simulation studies. The two primary methods that have been shown to
perform well in matched samples are using cluster-robust SEs and the
bootstrap, described below.</p>
<p>To compute SEs after g-computation, a method known as the delta
method is used; this is a way to compute the SEs of the derived
quantities (the expected potential outcomes and their contrast) from the
variance of the coefficients of the outcome models. For nonlinear models
(e.g., logistic regression), the delta method is only an approximation
subject to error (though in many cases this error is small and shrinks
in large samples). Because the delta method relies on the variance of
the coefficients from the outcome model, it is important to correctly
estimate these variances, using either robust or cluster-robust methods
as described below.</p>
<div class="section level4">
<h4 id="robust-and-cluster-robust-standard-errors">Robust and Cluster-Robust Standard Errors<a class="anchor" aria-label="anchor" href="#robust-and-cluster-robust-standard-errors"></a>
</h4>
<p><strong>Robust standard errors.</strong> Also known as sandwich SEs
(due to the form of the formula for computing them),
heteroscedasticity-consistent SEs, or Huber-White SEs, robust SEs are an
adjustment to the usual maximum likelihood or ordinary least squares SEs
that are robust to violations of some of the assumptions required for
usual SEs to be valid <span class="citation">(<a href="#ref-mackinnon1985" role="doc-biblioref">MacKinnon and White
1985</a>)</span>. Although there has been some debate about their
utility <span class="citation">(<a href="#ref-king2015" role="doc-biblioref">King and Roberts 2015</a>)</span>, robust SEs
rarely degrade inferences and often improve them. Generally, robust SEs
<strong>must</strong> be used when any non-uniform weights are included
in the estimation (e.g., with matching with replacement or inverse
probability weighting).</p>
<p><strong>Cluster-robust standard errors.</strong> A version of robust
SEs known as cluster-robust SEs <span class="citation">(<a href="#ref-liang1986" role="doc-biblioref">Liang and Zeger
1986</a>)</span> can be used to account for dependence between
observations within clusters (e.g., matched pairs). <span class="citation">Abadie and Spiess (<a href="#ref-abadie2019" role="doc-biblioref">2019</a>)</span> demonstrate analytically that
cluster-robust SEs are generally valid after matching, whereas regular
robust SEs can over- or under-estimate the true sampling variability of
the effect estimator depending on the specification of the outcome model
(if any) and degree of effect modification. A plethora of simulation
studies have further confirmed the validity of cluster-robust SEs after
matching <span class="citation">(e.g., <a href="#ref-austin2009a" role="doc-biblioref">Austin 2009</a>, <a href="#ref-austin2013" role="doc-biblioref">2013a</a>; <a href="#ref-austin2014" role="doc-biblioref">Austin and Small 2014</a>; <a href="#ref-gayat2012" role="doc-biblioref">Gayat et al. 2012</a>; <a href="#ref-wan2019" role="doc-biblioref">Wan 2019</a>)</span>. Given this evidence favoring
the use of cluster-robust SEs, we recommend them in most cases and use
them judiciously in the this guide<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>.</p>
</div>
<div class="section level4">
<h4 id="bootstrapping">Bootstrapping<a class="anchor" aria-label="anchor" href="#bootstrapping"></a>
</h4>
<p>One problem when using robust and cluster-robust SEs along with the
delta method is that the delta method is an approximation, as previously
mentioned. One solution to this problem is bootstrapping, which is a
technique used to simulate the sampling distribution of an estimator by
repeatedly drawing samples with replacement and estimating the effect in
each bootstrap sample <span class="citation">(<a href="#ref-efron1993" role="doc-biblioref">Efron and Tibshirani 1993</a>)</span>. From the
bootstrap distribution, SEs and confidence intervals can be computed in
several ways, including using the standard deviation of the bootstrap
estimates as the SE estimate or using the 2.5 and 97.5 percentiles as
95% confidence interval bounds. Bootstrapping tends to be most useful
when no analytic estimator of a SE is possible or has been derived yet.
Although <span class="citation">Abadie and Imbens (<a href="#ref-abadie2008" role="doc-biblioref">2008</a>)</span> found
analytically that the bootstrap is inappropriate for matched samples,
simulation evidence has found it to be adequate in many cases <span class="citation">(<a href="#ref-hill2006" role="doc-biblioref">Hill and
Reiter 2006</a>; <a href="#ref-austin2014" role="doc-biblioref">Austin
and Small 2014</a>; <a href="#ref-austin2017" role="doc-biblioref">Austin and Stuart 2017</a>)</span>.</p>
<p>Typically, bootstrapping involves performing the entire estimation
process in each bootstrap sample, including propensity score estimation,
matching, and effect estimation. This tends to be the most
straightforward route, though intervals from this method may be
conservative in some cases (i.e., they are wider than necessary to
achieve nominal coverage) <span class="citation">(<a href="#ref-austin2014" role="doc-biblioref">Austin and Small
2014</a>)</span>. Less conservative and more accurate intervals have
been found when using different forms of the bootstrap, including the
wild bootstrap develop by <span class="citation">Bodory et al. (<a href="#ref-bodory2020" role="doc-biblioref">2020</a>)</span> and the
matched/cluster bootstrap described by <span class="citation">Austin and
Small (<a href="#ref-austin2014" role="doc-biblioref">2014</a>)</span>
and <span class="citation">Abadie and Spiess (<a href="#ref-abadie2019" role="doc-biblioref">2019</a>)</span>. The cluster bootstrap involves
sampling matched pairs/strata of units from the matched sample and
performing the analysis within each sample composed of the sampled
pairs. <span class="citation">Abadie and Spiess (<a href="#ref-abadie2019" role="doc-biblioref">2019</a>)</span> derived
analytically that the cluster bootstrap is valid for estimating SEs and
confidence intervals in the same circumstances cluster robust SEs are;
indeed, the cluster bootstrap SE is known to approximate the
cluster-robust SE <span class="citation">(<a href="#ref-cameron2015" role="doc-biblioref">Cameron and Miller 2015</a>)</span>.</p>
<p>With bootstrapping, more bootstrap replications are always better but
can take time and increase the chances that at least one error will
occur within the bootstrap analysis (e.g., a bootstrap sample with zero
treated units or zero units with an event). In general, numbers of
replications upwards of 999 are recommended, with values one less than a
multiple of 100 preferred to avoid interpolation when using the
percentiles as confidence interval limits <span class="citation">(<a href="#ref-mackinnon2006" role="doc-biblioref">MacKinnon
2006</a>)</span>. There are several methods of computing bootstrap
confidence intervals, but the bias-corrected accelerated (BCa) bootstrap
confidence interval often performs best <span class="citation">(<a href="#ref-austin2014" role="doc-biblioref">Austin and Small 2014</a>;
<a href="#ref-carpenter2000" role="doc-biblioref">Carpenter and Bithell
2000</a>)</span> and is easy to implement, simply by setting
<code>type = "bca"</code> in the call to <code><a href="https://rdrr.io/pkg/boot/man/boot.ci.html" class="external-link">boot::boot.ci()</a></code>
after running <code><a href="https://rdrr.io/pkg/boot/man/boot.html" class="external-link">boot::boot()</a></code><a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a>.</p>
<p>Most of this guide will consider analytic (i.e., non-bootstrapping)
approaches to estimating uncertainty; the section “Using Bootstrapping
to Estimate Confidence Intervals” describes broadly how to use
bootstrapping. Although analytic estimates are faster to compute, in
many cases bootstrap confidence intervals are more accurate.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="estimating-treatment-effects-and-standard-errors-after-matching">Estimating Treatment Effects and Standard Errors After Matching<a class="anchor" aria-label="anchor" href="#estimating-treatment-effects-and-standard-errors-after-matching"></a>
</h2>
<p>Below, we describe effect estimation after matching. We’ll be using a
simulated toy dataset <code>d</code> with several outcome types. Code to
generate the dataset is at the end of this document. The focus here is
not on evaluating the methods but simply on demonstrating them. In all
cases, the correct propensity score model is used. Below we display the
first six rows of <code>d</code>:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   A      X1      X2      X3       X4 X5      X6      X7      X8       X9      Y_C Y_B     Y_S</span></span>
<span><span class="co">## 1 0  0.1725 -1.4283 -0.4103 -2.36059  1 -1.1199  0.6398 -0.4840 -0.59385  0.07104   0  278.46</span></span>
<span><span class="co">## 2 0 -1.0959  0.8463  0.2456 -0.12333  1 -2.2687 -1.4491 -0.5514 -0.31439  0.15619   0  330.63</span></span>
<span><span class="co">## 3 0  0.1768  0.7905 -0.8436  0.82366  1 -0.2221  0.2971 -0.6966 -0.69516 -0.85180   1  369.94</span></span>
<span><span class="co">## 4 0 -0.4595  0.1726  1.9542 -0.62661  1 -0.4019 -0.8294 -0.5384  0.20729 -2.35184   0   91.06</span></span>
<span><span class="co">## 5 1  0.3563 -1.8121  0.8135 -0.67189  1 -0.8297  1.7297 -0.6439 -0.02648  0.68058   0  182.73</span></span>
<span><span class="co">## 6 0 -2.4313 -1.7984 -1.2940  0.04609  1 -1.2419 -1.1252 -1.8659 -0.56513 -5.62260   0 2563.73</span></span></code></pre>
<p><code>A</code> is the treatment variable, <code>X1</code> through
<code>X9</code> are covariates, <code>Y_C</code> is a continuous
outcome, <code>Y_B</code> is a binary outcome, and <code>Y_S</code> is a
survival outcome.</p>
<p>We will need to the following packages to perform the desired
analyses:</p>
<ul>
<li>
<code>marginaleffects</code> provides the <code><a href="https://vincentarelbundock.github.io/marginaleffects/reference/comparisons.html" class="external-link">comparisons()</a></code>
function for performing g-computation and estimating the SEs and
confidence intervals of the average estimate potential outcomes and
treatment effects</li>
<li>
<code>sandwich</code> is used internally by
<code>marginaleffects</code> to compute robust and cluster-robust
SEs</li>
<li>
<code>survival</code> provides <code><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph()</a></code> to estimate the
coefficients in a Cox-proportional hazards model for the marginal hazard
ratio, which we will use for survival outcomes.</li>
</ul>
<p>Of course, we also need <code>MatchIt</code> to perform the
matching.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://kosukeimai.github.io/MatchIt/">"MatchIt"</a></span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://vincentarelbundock.github.io/marginaleffects/" class="external-link">"marginaleffects"</a></span><span class="op">)</span></span></code></pre></div>
<p>All effect estimates will be computed using
<code>marginaleffects::comparions()</code>, even when its use may be
superfluous (e.g., for performing a t-test in the matched set). As
previously mentioned, this is because it is useful to have a single
workflow that works no matter the situation, perhaps with very slight
modifications to accommodate different contexts. Using
<code><a href="https://vincentarelbundock.github.io/marginaleffects/reference/comparisons.html" class="external-link">comparisons()</a></code> has several advantages, even when the
alternatives are simple: it only provides the effect estimate, and not
other coefficients; it automatically incorporates robust and
cluster-robust SEs if requested; and it always produces average marginal
effects for the correct population if requested.</p>
<p>Other packages may be of use but are not used here. There are
alternatives to the <code>marginaleffects</code> package for computing
average marginal effects, including <code>margins</code> and
<code>stdReg</code>. The <code>survey</code> package can be used to
estimate robust SEs incorporating weights and provides functions for
survey-weighted generalized linear models and Cox-proportional hazards
models. It is often used with propensity score weighting.</p>
<div class="section level3">
<h3 id="the-standard-case">The Standard Case<a class="anchor" aria-label="anchor" href="#the-standard-case"></a>
</h3>
<p>For almost all matching methods, whether a caliper, common support
restriction, exact matching specification, or <span class="math inline">\(k\)</span>:1 matching specification is used,
estimating the effect in the matched dataset is straightforward and
involves fitting a model for the outcome that incorporates the matching
weights<a href="#fn3" class="footnote-ref" id="fnref3"><sup>3</sup></a>,
then estimating the treatment effect using g-computation (i.e., using
<code><a href="https://vincentarelbundock.github.io/marginaleffects/reference/comparisons.html" class="external-link">marginaleffects::comparisons()</a></code>) with a cluster-robust SE to
account for pair membership. This procedure is the same for continuous
and binary outcomes with and without covariates.</p>
<p>There are a few adjustments that need to be made for certain
scenarios, which we describe in the section “Adjustments to the Standard
Case”. These adjustments include for the following cases: when matching
for the ATE rather than the ATT, for matching with replacement, for
matching with a method that doesn’t involve creating pairs (e.g.,
cardinality and template matching and coarsened exact matching), for
subclassification, for estimating effects with binary outcomes, and for
estimating effects with survival outcomes. You must read the Standard
Case to understand the basic procedure before reading about these
special scenarios.</p>
<p>Here, we demonstrate the faster analytic approach to estimating
confidence intervals; for the bootstrap approach, see the section “Using
Bootstrapping to Estimate Confidence Intervals” below.</p>
<p>First, we will perform full matching on the propensity score for the
ATT. Remember, all matching methods use this exact procedure or a slight
variation, so this section is critical even if you are using a different
matching method.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Optimal full matching on the PS for the ATT</span></span>
<span><span class="va">mF</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/matchit.html">matchit</a></span><span class="op">(</span><span class="va">A</span> <span class="op">~</span> <span class="va">X1</span> <span class="op">+</span> <span class="va">X2</span> <span class="op">+</span> <span class="va">X3</span> <span class="op">+</span> <span class="va">X4</span> <span class="op">+</span> <span class="va">X5</span> <span class="op">+</span> </span>
<span>                 <span class="va">X6</span> <span class="op">+</span> <span class="va">X7</span> <span class="op">+</span> <span class="va">X8</span> <span class="op">+</span> <span class="va">X9</span>, data <span class="op">=</span> <span class="va">d</span>,</span>
<span>               method <span class="op">=</span> <span class="st">"full"</span>, estimand <span class="op">=</span> <span class="st">"ATT"</span><span class="op">)</span></span>
<span><span class="va">mF</span></span></code></pre></div>
<pre><code><span><span class="co">## A matchit object</span></span>
<span><span class="co">##  - method: Optimal full matching</span></span>
<span><span class="co">##  - distance: Propensity score</span></span>
<span><span class="co">##              - estimated with logistic regression</span></span>
<span><span class="co">##  - number of obs.: 2000 (original), 2000 (matched)</span></span>
<span><span class="co">##  - target estimand: ATT</span></span>
<span><span class="co">##  - covariates: X1, X2, X3, X4, X5, X6, X7, X8, X9</span></span></code></pre>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Extract matched data</span></span>
<span><span class="va">md</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/match.data.html">match.data</a></span><span class="op">(</span><span class="va">mF</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">md</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   A      X1      X2      X3       X4 X5      X6      X7      X8       X9      Y_C Y_B     Y_S distance weights subclass</span></span>
<span><span class="co">## 1 0  0.1725 -1.4283 -0.4103 -2.36059  1 -1.1199  0.6398 -0.4840 -0.59385  0.07104   0  278.46  0.08461 0.23568       57</span></span>
<span><span class="co">## 2 0 -1.0959  0.8463  0.2456 -0.12333  1 -2.2687 -1.4491 -0.5514 -0.31439  0.15619   0  330.63  0.01855 0.04714      132</span></span>
<span><span class="co">## 3 0  0.1768  0.7905 -0.8436  0.82366  1 -0.2221  0.2971 -0.6966 -0.69516 -0.85180   1  369.94  0.22210 0.58919       97</span></span>
<span><span class="co">## 4 0 -0.4595  0.1726  1.9542 -0.62661  1 -0.4019 -0.8294 -0.5384  0.20729 -2.35184   0   91.06  0.04180 0.16834      136</span></span>
<span><span class="co">## 5 1  0.3563 -1.8121  0.8135 -0.67189  1 -0.8297  1.7297 -0.6439 -0.02648  0.68058   0  182.73  0.43291 1.00000      205</span></span>
<span><span class="co">## 6 0 -2.4313 -1.7984 -1.2940  0.04609  1 -1.2419 -1.1252 -1.8659 -0.56513 -5.62260   0 2563.73  0.04998 0.08221      169</span></span></code></pre>
<p>Typically one would assess balance and ensure that this matching
specification works, but we will skip that step here to focus on effect
estimation. See <code><a href="../articles/MatchIt.html">vignette("MatchIt")</a></code> and
<code><a href="../articles/assessing-balance.html">vignette("assessing-balance")</a></code> for more information on this
necessary step. Because we did not use a caliper, the target estimand is
the ATT.</p>
<p>We perform all analyses using the matched dataset, <code>md</code>,
which, for matching methods that involve dropping units, contains only
the units retained in the sample.</p>
<p>First, we fit a model for the outcome given the treatment and
(optionally) the covariates. It’s usually a good idea to include
treatment-covariate interactions, which we do below, but this is not
always necessary, especially when excellent balance has been achieved.
You can also include the propensity score (usually labeled
<code>distance</code> in the <code><a href="../reference/match.data.html">match.data()</a></code> output), which
can add some robustness, especially when modeled flexibly (e.g., with
polynomial terms or splines) <span class="citation">(<a href="#ref-austinDoublePropensityscoreAdjustment2017" role="doc-biblioref">Austin 2017</a>)</span>; see <a href="https://stats.stackexchange.com/a/580174/116195" class="external-link">here</a> for an
example.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Linear model with covariates</span></span>
<span><span class="va">fit1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">Y_C</span> <span class="op">~</span> <span class="va">A</span> <span class="op">*</span> <span class="op">(</span><span class="va">X1</span> <span class="op">+</span> <span class="va">X2</span> <span class="op">+</span> <span class="va">X3</span> <span class="op">+</span> <span class="va">X4</span> <span class="op">+</span> <span class="va">X5</span> <span class="op">+</span> </span>
<span>                        <span class="va">X6</span> <span class="op">+</span> <span class="va">X7</span> <span class="op">+</span> <span class="va">X8</span> <span class="op">+</span> <span class="va">X9</span><span class="op">)</span>,</span>
<span>           data <span class="op">=</span> <span class="va">md</span>, weights <span class="op">=</span> <span class="va">weights</span><span class="op">)</span></span></code></pre></div>
<p>Next, we use <code><a href="https://vincentarelbundock.github.io/marginaleffects/reference/comparisons.html" class="external-link">marginaleffects::comparisons()</a></code> to estimate
the ATT.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">comp1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://vincentarelbundock.github.io/marginaleffects/reference/comparisons.html" class="external-link">comparisons</a></span><span class="op">(</span><span class="va">fit1</span>,</span>
<span>                     variables <span class="op">=</span> <span class="st">"A"</span>,</span>
<span>                     vcov <span class="op">=</span> <span class="op">~</span><span class="va">subclass</span>,</span>
<span>                     newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">md</span>, <span class="va">A</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>                     wts <span class="op">=</span> <span class="st">"weights"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">comp1</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   Term Contrast Effect Std. Error z value Pr(&gt;|z|) 2.5 % 97.5 %</span></span>
<span><span class="co">## 1    A    1 - 0   1.74      0.494    3.52  0.00044 0.768    2.7</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Model type:  lm </span></span>
<span><span class="co">## Prediction type:  response</span></span></code></pre>
<p>Let’s break down the call to <code><a href="https://vincentarelbundock.github.io/marginaleffects/reference/comparisons.html" class="external-link">comparisons()</a></code>: to the first
argument, we supply the model fit, <code>fit</code>; to the
<code>variables</code> argument, the name of the treatment
(<code>"A"</code>); to the <code>vcov</code> argument, a formula with
subclass membership (<code>~subclass</code>) to request cluster-robust
SEs; to the <code>newdata</code> argument, a version of the matched
dataset containing only the treated units
(<code>subset(md, A == 1)</code>) to request the ATT; and to the
<code>wts</code> argument, the names of the variable in <code>md</code>
containing the matching weights (<code>"weights"</code>) to ensure they
are included in the analysis. Some of these arguments differ depending
on the specifics of the matching method and outcome type; see the
sections below for information.</p>
<p>If, in addition to the effect estimate, we want the average estimated
potential outcomes, we can use
<code><a href="https://vincentarelbundock.github.io/marginaleffects/reference/predictions.html" class="external-link">marginaleffects::predictions()</a></code>, which we demonstrate below.
Note the interpretation of the resulting estimates as the expected
potential outcomes is only valid if all covariates present in the
outcome model (if any) are interacted with the treatment.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://vincentarelbundock.github.io/marginaleffects/reference/predictions.html" class="external-link">predictions</a></span><span class="op">(</span><span class="va">fit1</span>,</span>
<span>                     variables <span class="op">=</span> <span class="st">"A"</span>,</span>
<span>                     vcov <span class="op">=</span> <span class="op">~</span><span class="va">subclass</span>,</span>
<span>                     newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">md</span>, <span class="va">A</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>                     wts <span class="op">=</span> <span class="st">"weights"</span>,</span>
<span>                     by <span class="op">=</span> <span class="st">"A"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">pred1</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   A Predicted Std. Error z value Pr(&gt;|z|) CI low CI high</span></span>
<span><span class="co">## 1 0      2.16      0.371    5.82    6e-09   1.43    2.89</span></span>
<span><span class="co">## 2 1      3.89      0.233   16.72   &lt;2e-16   3.44    4.35</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Model type:  lm </span></span>
<span><span class="co">## Prediction type:  response</span></span></code></pre>
<p>We can see that the difference in potential outcome means is equal to
the average treatment effect computed previously<a href="#fn4" class="footnote-ref" id="fnref4"><sup>4</sup></a>. Almost all of the
arguments to <code><a href="https://vincentarelbundock.github.io/marginaleffects/reference/predictions.html" class="external-link">predictions()</a></code> are the same as those to
<code><a href="https://vincentarelbundock.github.io/marginaleffects/reference/comparisons.html" class="external-link">comparisons()</a></code>; the only difference is that the
<code>by</code> argument needs to be specified naming the treatment.</p>
</div>
<div class="section level3">
<h3 id="adjustments-to-the-standard-case">Adjustments to the Standard Case<a class="anchor" aria-label="anchor" href="#adjustments-to-the-standard-case"></a>
</h3>
<p>This section explains how the procedure might differ if any of the
following special circumstances occur.</p>
<div class="section level4">
<h4 id="matching-for-the-ate">Matching for the ATE<a class="anchor" aria-label="anchor" href="#matching-for-the-ate"></a>
</h4>
<p>When matching for the ATE (including [coarsened] exact matching, full
matching, subclassification, and cardinality matching), everything is
identical to the Standard Case except that in the calls to
<code><a href="https://vincentarelbundock.github.io/marginaleffects/reference/comparisons.html" class="external-link">comparisons()</a></code> and <code><a href="https://vincentarelbundock.github.io/marginaleffects/reference/predictions.html" class="external-link">predictions()</a></code>, the
<code>newdata</code> argument is omitted (or can be replaced with
<code>newdata = md</code>). This is because the estimated potential
outcomes are computed for the full matched sample rather than just the
treated units.</p>
</div>
<div class="section level4">
<h4 id="matching-with-replacement">Matching with replacement<a class="anchor" aria-label="anchor" href="#matching-with-replacement"></a>
</h4>
<p>When matching with replacement (i.e., nearest neighbor or genetic
matching with <code>replace = TRUE</code>), effect and SE estimation
need to account for control unit multiplicity (i.e., repeated use) and
within-pair correlations <span class="citation">(<a href="#ref-hill2006" role="doc-biblioref">Hill and Reiter 2006</a>; <a href="#ref-austin2020a" role="doc-biblioref">Austin and Cafri
2020</a>)</span>. Although <span class="citation">Abadie and Imbens (<a href="#ref-abadie2008" role="doc-biblioref">2008</a>)</span>
demonstrated analytically that bootstrap SEs may be invalid for matching
with replacement, simulation work by <span class="citation">Hill and
Reiter (<a href="#ref-hill2006" role="doc-biblioref">2006</a>)</span>
and <span class="citation">Bodory et al. (<a href="#ref-bodory2020" role="doc-biblioref">2020</a>)</span> has found that bootstrap SEs are
adequate and generally slightly conservative. See the section “Using
Bootstrapping to Estimate Confidence Intervals” for instructions on
using the bootstrap and an example that use matching with
replacement.</p>
<p>Because control units do not belong to unique pairs, there is no pair
membership in the <code><a href="../reference/match.data.html">match.data()</a></code> output. One can simply
change <code>vcov = ~subclass</code> to <code>vcov = "HC3"</code> in the
calls to <code><a href="https://vincentarelbundock.github.io/marginaleffects/reference/comparisons.html" class="external-link">comparisons()</a></code> and <code><a href="https://vincentarelbundock.github.io/marginaleffects/reference/predictions.html" class="external-link">predictions()</a></code> to
use robust SEs instead of cluster-robust SEs, as recommended by <span class="citation">Hill and Reiter (<a href="#ref-hill2006" role="doc-biblioref">2006</a>)</span>. There is some evidence for an
alternative approach that incorporates pair membership and adjusts for
reuse of control units, though this has only been studied for survival
outcomes <span class="citation">(<a href="#ref-austin2020a" role="doc-biblioref">Austin and Cafri 2020</a>)</span>. This adjustment
involves using two-way cluster-robust SEs with pair membership and unit
ID as the clustering variables. For continuous and binary outcomes, this
involves the following two changes: 1) replace <code><a href="../reference/match.data.html">match.data()</a></code>
with <code><a href="../reference/match.data.html">get_matches()</a></code>, which produces a dataset with a row per
unit per pair, meaning control units matched to multiple treated units
will appear multiple times in the dataset; 2) set
<code>vcov = ~subclass + id</code> in the calls to
<code><a href="https://vincentarelbundock.github.io/marginaleffects/reference/comparisons.html" class="external-link">comparisons()</a></code> and <code><a href="https://vincentarelbundock.github.io/marginaleffects/reference/predictions.html" class="external-link">predictions()</a></code>. For survival
outcomes, a special procedure must be used; see the section on survival
outcomes below.</p>
</div>
<div class="section level4">
<h4 id="matching-without-pairing">Matching without pairing<a class="anchor" aria-label="anchor" href="#matching-without-pairing"></a>
</h4>
<p>Some matching methods do not involve creating pairs; these include
cardinality and template matching with <code>mahvars = NULL</code> (the
default), exact matching, and coarsened exact matching with
<code>k2k = FALSE</code> (the default). The only change that needs to be
made to the Standard Case is that one should change
<code>vcov = ~subclass</code> to <code>vcov = "HC3"</code> in the calls
to <code><a href="https://vincentarelbundock.github.io/marginaleffects/reference/comparisons.html" class="external-link">comparisons()</a></code> and <code><a href="https://vincentarelbundock.github.io/marginaleffects/reference/predictions.html" class="external-link">predictions()</a></code> to use
robust SEs instead of cluster-robust SEs. Remember that if matching is
done for the ATE (even if units are dropped), the <code>newdata</code>
argument should be dropped.</p>
</div>
<div class="section level4">
<h4 id="propensity-score-subclassification">Propensity score subclassification<a class="anchor" aria-label="anchor" href="#propensity-score-subclassification"></a>
</h4>
<p>There are two natural ways to estimate marginal effects after
subclassification: the first is to estimate subclass-specific treatment
effects and pool them using an average marginal effects procedure, and
the second is to use the stratum weights to estimate a single average
marginal effect. This latter approach is also known as marginal mean
weighting through stratification (MMWS), and is described in detail by
<span class="citation">Hong (<a href="#ref-hong2010" role="doc-biblioref">2010</a>)</span><a href="#fn5" class="footnote-ref" id="fnref5"><sup>5</sup></a>. When done properly, both methods should
yield similar or identical estimates of the treatment effect.</p>
<p>All of the methods described above for the Standard Case also work
with MMWS because the formation of the weights is the same; the only
difference is that it is not appropriate to use cluster-robust SEs with
MMWS because of how few clusters are present, so one should change
<code>vcov = ~subclass</code> to <code>vcov = "HC3"</code> in the calls
to <code><a href="https://vincentarelbundock.github.io/marginaleffects/reference/comparisons.html" class="external-link">comparisons()</a></code> and <code><a href="https://vincentarelbundock.github.io/marginaleffects/reference/predictions.html" class="external-link">predictions()</a></code> to use
robust SEs instead of cluster-robust SEs. The subclasses can optionally
be included in the outcome model (optionally interacting with treatment)
as an alternative to including the propensity score.</p>
<p>The subclass-specific approach omits the weights and uses the
subclasses directly. It is only appropriate when there are a small
number of subclasses relative to the sample size. In the outcome model,
<code>subclass</code> should interact with all other predictors in the
model (including the treatment, covariates, and interactions, if any),
and the <code>weights</code> argument should be omitted. In the calls to
<code><a href="https://vincentarelbundock.github.io/marginaleffects/reference/comparisons.html" class="external-link">comparisons()</a></code> and <code><a href="https://vincentarelbundock.github.io/marginaleffects/reference/predictions.html" class="external-link">predictions()</a></code>, the
<code>wts</code> argument should be omitted. As with MMWS, one should
change <code>vcov = ~subclass</code> to <code>vcov = "HC3"</code> in the
calls to <code><a href="https://vincentarelbundock.github.io/marginaleffects/reference/comparisons.html" class="external-link">comparisons()</a></code> and <code><a href="https://vincentarelbundock.github.io/marginaleffects/reference/predictions.html" class="external-link">predictions()</a></code>. See
an example below:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Subclassification on the PS for the ATT</span></span>
<span><span class="va">mS</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/matchit.html">matchit</a></span><span class="op">(</span><span class="va">A</span> <span class="op">~</span> <span class="va">X1</span> <span class="op">+</span> <span class="va">X2</span> <span class="op">+</span> <span class="va">X3</span> <span class="op">+</span> <span class="va">X4</span> <span class="op">+</span> <span class="va">X5</span> <span class="op">+</span> </span>
<span>                 <span class="va">X6</span> <span class="op">+</span> <span class="va">X7</span> <span class="op">+</span> <span class="va">X8</span> <span class="op">+</span> <span class="va">X9</span>, data <span class="op">=</span> <span class="va">d</span>,</span>
<span>               method <span class="op">=</span> <span class="st">"subclass"</span>, estimand <span class="op">=</span> <span class="st">"ATT"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#Extract matched data</span></span>
<span><span class="va">md</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/match.data.html">match.data</a></span><span class="op">(</span><span class="va">mS</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fitS</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">Y_C</span> <span class="op">~</span> <span class="va">subclass</span> <span class="op">*</span> <span class="op">(</span><span class="va">A</span> <span class="op">*</span> <span class="op">(</span><span class="va">X1</span> <span class="op">+</span> <span class="va">X2</span> <span class="op">+</span> <span class="va">X3</span> <span class="op">+</span> <span class="va">X4</span> <span class="op">+</span> <span class="va">X5</span> <span class="op">+</span> </span>
<span>                                    <span class="va">X6</span> <span class="op">+</span> <span class="va">X7</span> <span class="op">+</span> <span class="va">X8</span> <span class="op">+</span> <span class="va">X9</span><span class="op">)</span><span class="op">)</span>,</span>
<span>           data <span class="op">=</span> <span class="va">md</span><span class="op">)</span></span>
<span></span>
<span><span class="va">compS</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://vincentarelbundock.github.io/marginaleffects/reference/comparisons.html" class="external-link">comparisons</a></span><span class="op">(</span><span class="va">fitS</span>,</span>
<span>                     variables <span class="op">=</span> <span class="st">"A"</span>,</span>
<span>                     vcov <span class="op">=</span> <span class="st">"HC3"</span>,</span>
<span>                     newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">md</span>, <span class="va">A</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">compS</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   Term Contrast Effect Std. Error z value Pr(&gt;|z|) 2.5 % 97.5 %</span></span>
<span><span class="co">## 1    A    1 - 0   1.65      0.364    4.54  5.6e-06  0.94   2.37</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Model type:  lm </span></span>
<span><span class="co">## Prediction type:  response</span></span></code></pre>
<p>A model with fewer terms may be required when subclasses are small;
removing covariates or their interactions with treatment may be required
and can increase precision in smaller datasets. Remember that if
subclassification is done for the ATE (even if units are dropped), the
<code>newdata</code> argument should be dropped.</p>
</div>
<div class="section level4">
<h4 id="binary-outcomes">Binary outcomes<a class="anchor" aria-label="anchor" href="#binary-outcomes"></a>
</h4>
<p>Estimating effects on binary outcomes is essentially the same as for
continuous outcomes. The main difference is that there are several
measures of the effect one can consider, which include the odds ratio
(OR), risk ratio/relative risk (RR), and risk difference (RD), and the
syntax to <code><a href="https://vincentarelbundock.github.io/marginaleffects/reference/comparisons.html" class="external-link">comparisons()</a></code> depends on which one is desired.
The outcome model should be one appropriate for binary outcomes (e.g.,
logistic regression) but is unrelated to the desired effect measure
because we can compute any of the above effect measures using
<code><a href="https://vincentarelbundock.github.io/marginaleffects/reference/comparisons.html" class="external-link">comparisons()</a></code> after the logistic regression.</p>
<p>To fit a logistic regression model, change <code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm()</a></code> to
<code><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm()</a></code> and set <code>family = quasibinomial()</code><a href="#fn6" class="footnote-ref" id="fnref6"><sup>6</sup></a>. To
compute the marginal RD, we can use exactly the same syntax as in the
Standard Case; nothing needs to change<a href="#fn7" class="footnote-ref" id="fnref7"><sup>7</sup></a>.</p>
<p>To compute the marginal RR, we need to add
<code>transform_pre = "lnratioavg"</code> to <code><a href="https://vincentarelbundock.github.io/marginaleffects/reference/comparisons.html" class="external-link">comparisons()</a></code>;
this computes the marginal log RR. To get the marginal RR, we need to
add <code>transform_avg = exp</code> to <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code>, which
exponentiates the marginal log RR. It is important that inference (i.e.,
computing SEs and p-values) be done using the marginal log RR, but we
typically want to interpret our effects and confidence intervals using
the marginal RR. The code below computes the effects and displays the
statistics of interest:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Logistic regression model with covariates</span></span>
<span><span class="va">fit2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">Y_B</span> <span class="op">~</span> <span class="va">A</span> <span class="op">*</span> <span class="op">(</span><span class="va">X1</span> <span class="op">+</span> <span class="va">X2</span> <span class="op">+</span> <span class="va">X3</span> <span class="op">+</span> <span class="va">X4</span> <span class="op">+</span> <span class="va">X5</span> <span class="op">+</span> </span>
<span>                        <span class="va">X6</span> <span class="op">+</span> <span class="va">X7</span> <span class="op">+</span> <span class="va">X8</span> <span class="op">+</span> <span class="va">X9</span><span class="op">)</span>,</span>
<span>            data <span class="op">=</span> <span class="va">md</span>, weights <span class="op">=</span> <span class="va">weights</span>,</span>
<span>            family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">quasibinomial</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#Compute effects</span></span>
<span><span class="va">comp2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://vincentarelbundock.github.io/marginaleffects/reference/comparisons.html" class="external-link">comparisons</a></span><span class="op">(</span><span class="va">fit2</span>,</span>
<span>                     variables <span class="op">=</span> <span class="st">"A"</span>,</span>
<span>                     vcov <span class="op">=</span> <span class="op">~</span><span class="va">subclass</span>,</span>
<span>                     newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">md</span>, <span class="va">A</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>                     wts <span class="op">=</span> <span class="st">"weights"</span>,</span>
<span>                     transform_pre <span class="op">=</span> <span class="st">"lnratioavg"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#Log RR, standard error, and Z value</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">comp2</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   Term              Contrast Effect Std. Error z value Pr(&gt;|z|) 2.5 % 97.5 %</span></span>
<span><span class="co">## 1    A ln(mean(1) / mean(0))  0.452     0.0551    8.21   &lt;2e-16 0.344   0.56</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Model type:  glm </span></span>
<span><span class="co">## Prediction type:  response</span></span></code></pre>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#RR and confidence interval</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">comp2</span>, transform_avg <span class="op">=</span> <span class="va">exp</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   Term              Contrast Effect Pr(&gt;|z|) 2.5 % 97.5 %</span></span>
<span><span class="co">## 1    A ln(mean(1) / mean(0))   1.57   &lt;2e-16  1.41   1.75</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Model type:  glm </span></span>
<span><span class="co">## Prediction type:  response </span></span>
<span><span class="co">## Average-transformation:</span></span></code></pre>
<p>The first <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> output displays the marginal log RR,
its SE, Z-value, the p-value for the Z-test against 0, and its
confidence interval. The second <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> output displays
the marginal RR, the p-value for the above test, and the confidence
interval for the RR. (Note that even though the <code>Contrast</code>
label still suggests the log risk ratio, the risk ratio is actually
displayed. You can confirm this by manually exponentiating the log risk
ratio computed just before.)</p>
<p>For the marginal OR, the only thing that needs to change is that
<code>transform_pre</code> should be set to <code>"lnoravg"</code>.</p>
</div>
<div class="section level4">
<h4 id="survival-outcomes">Survival outcomes<a class="anchor" aria-label="anchor" href="#survival-outcomes"></a>
</h4>
<p>There are several measures of effect size for survival outcomes. When
using the Cox proportional hazards model, the quantity of interest is
the hazard ratio (HR) between the treated and control groups. As with
the OR, the HR is non-collapsible, which means the estimated HR will
only be a valid estimate of the marginal HR when no other covariates are
included in the model. Other effect measures, such as the difference in
mean survival times or probability of survival after a given time, can
be treated just like continuous and binary outcomes as previously
described.</p>
<p>For the HR, we cannot compute average marginal effects and must use
the coefficient on treatment in a Cox model fit without covariates<a href="#fn8" class="footnote-ref" id="fnref8"><sup>8</sup></a>. This
means that we cannot use the procedures from the Standard Case. Here we
describe estimating the marginal HR using <code><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph()</a></code> from the
<code>survival</code> package. (See
<code><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">help("coxph", package = "survival")</a></code> for more information on
this model.) To request cluster-robust SEs as recommended by <span class="citation">Austin (<a href="#ref-austin2013a" role="doc-biblioref">2013b</a>)</span>, we need to supply pair
membership (stored in the <code>subclass</code> column of
<code>md</code>) to the <code>cluster</code> argument and set
<code>robust = TRUE</code>. For matching methods that don’t involve
pairing (e.g., cardinality and template matching and [coarsened] exact
matching), we can omit the <code>cluster</code> argument (but keep
<code>robust = TRUE</code>)<a href="#fn9" class="footnote-ref" id="fnref9"><sup>9</sup></a>.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/therneau/survival" class="external-link">"survival"</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co">#Cox Regression for marginal HR</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">Y_S</span><span class="op">)</span> <span class="op">~</span> <span class="va">A</span>, data <span class="op">=</span> <span class="va">md</span>, robust <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>      weights <span class="op">=</span> <span class="va">weights</span>, cluster <span class="op">=</span> <span class="va">subclass</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Call:</span></span>
<span><span class="co">## coxph(formula = Surv(Y_S) ~ A, data = md, weights = weights, </span></span>
<span><span class="co">##     robust = TRUE, cluster = subclass)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##   coef exp(coef) se(coef) robust se  z      p</span></span>
<span><span class="co">## A 0.45      1.57     0.05      0.04 12 &lt;2e-16</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Likelihood ratio test=63  on 1 df, p=2e-15</span></span>
<span><span class="co">## n= 2000, number of events= 2000</span></span></code></pre>
<p>The <code>coef</code> column contains the log HR, and
<code>exp(coef)</code> contains the HR. Remember to always use the
<code>robust se</code> for the SE of the log HR. The displayed z-test
p-value results from using the robust SE.</p>
<p>For matching with replacement, a special procedure described by <span class="citation">Austin and Cafri (<a href="#ref-austin2020a" role="doc-biblioref">2020</a>)</span> can be necessary for valid
inference. According to the results of their simulation studies, when
the treatment prevalence is low (&lt;30%), a SE that does not involve
pair membership (i.e., the <code><a href="../reference/match.data.html">match.data()</a></code> approach, as
demonstrated above) is sufficient. When treatment prevalence is higher,
the SE that ignores pair membership may be too low, and the authors
recommend using a custom SE estimator that uses information about both
multiplicity and pairing.</p>
<p>Doing so must be done manually for survival models using
<code><a href="../reference/match.data.html">get_matches()</a></code> and several calls to <code><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph()</a></code> as
demonstrated in the appendix of <span class="citation">Austin and Cafri
(<a href="#ref-austin2020a" role="doc-biblioref">2020</a>)</span>. We
demonstrate this below:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#get_matches() after matching with replacement</span></span>
<span><span class="va">gm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/match.data.html">get_matches</a></span><span class="op">(</span><span class="va">mR</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#Austin &amp; Cafri's (2020) SE estimator</span></span>
<span><span class="va">fs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">Y_S</span><span class="op">)</span> <span class="op">~</span> <span class="va">A</span>, data <span class="op">=</span> <span class="va">gm</span>, robust <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>      weights <span class="op">=</span> <span class="va">weights</span>, cluster <span class="op">=</span> <span class="va">subclass</span><span class="op">)</span></span>
<span><span class="va">Vs</span> <span class="op">&lt;-</span> <span class="va">fs</span><span class="op">$</span><span class="va">var</span></span>
<span><span class="va">ks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nlevels.html" class="external-link">nlevels</a></span><span class="op">(</span><span class="va">gm</span><span class="op">$</span><span class="va">subclass</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">Y_S</span><span class="op">)</span> <span class="op">~</span> <span class="va">A</span>, data <span class="op">=</span> <span class="va">gm</span>, robust <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>      weights <span class="op">=</span> <span class="va">weights</span>, cluster <span class="op">=</span> <span class="va">id</span><span class="op">)</span></span>
<span><span class="va">Vi</span> <span class="op">&lt;-</span> <span class="va">fi</span><span class="op">$</span><span class="va">var</span></span>
<span><span class="va">ki</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">gm</span><span class="op">$</span><span class="va">id</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">Y_S</span><span class="op">)</span> <span class="op">~</span> <span class="va">A</span>, data <span class="op">=</span> <span class="va">gm</span>, robust <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>      weights <span class="op">=</span> <span class="va">weights</span><span class="op">)</span></span>
<span><span class="va">Vc</span> <span class="op">&lt;-</span> <span class="va">fc</span><span class="op">$</span><span class="va">var</span></span>
<span><span class="va">kc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">gm</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#Compute the variance and sneak it back into the fit object</span></span>
<span><span class="va">fc</span><span class="op">$</span><span class="va">var</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">ks</span><span class="op">/</span><span class="op">(</span><span class="va">ks</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">*</span><span class="va">Vs</span> <span class="op">+</span> <span class="op">(</span><span class="va">ki</span><span class="op">/</span><span class="op">(</span><span class="va">ki</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">*</span><span class="va">Vi</span> <span class="op">-</span> <span class="op">(</span><span class="va">kc</span><span class="op">/</span><span class="op">(</span><span class="va">kc</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">*</span><span class="va">Vc</span></span>
<span></span>
<span><span class="va">fc</span></span></code></pre></div>
<p>The <code>robust se</code> column contains the computed SE, and the
reported Z-test uses this SE. The <code>se(coef)</code> column should be
ignored.</p>
</div>
</div>
<div class="section level3">
<h3 id="using-bootstrapping-to-estimate-confidence-intervals">Using Bootstrapping to Estimate Confidence Intervals<a class="anchor" aria-label="anchor" href="#using-bootstrapping-to-estimate-confidence-intervals"></a>
</h3>
<p>The bootstrap is an alternative to the delta method for estimating
confidence intervals for estimated effects. See the section
Bootstrapping above for details. Here, we’ll demonstrate two forms of
the bootstrap: 1) the standard bootstrap, which involve resampling units
and performing matching and effect estimation within each bootstrap
sample, and 2) the cluster bootstrap, which involves resampling pairs
after matching and estimating the effect in each bootstrap sample. For
both, we will use functionality in the <code>boot</code> package. It is
critical to set a seed using <code><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed()</a></code> prior to performing
the bootstrap in order for results to be replicable.</p>
<div class="section level4">
<h4 id="the-standard-bootstrap">The standard bootstrap<a class="anchor" aria-label="anchor" href="#the-standard-bootstrap"></a>
</h4>
<p>For the standard bootstrap, we need a function that takes in the
original dataset and a vector of sampled unit indices and returns the
estimated quantity of interest. This function should perform the
matching on the bootstrap sample, fit the outcome model, and estimate
the treatment effect using g-computation. In this example, we’ll use
matching with replacement, since the standard bootstrap has been found
to work well with it <span class="citation">(<a href="#ref-bodory2020" role="doc-biblioref">Bodory et al. 2020</a>; <a href="#ref-hill2006" role="doc-biblioref">Hill and Reiter 2006</a>)</span>, despite some
analytic results recommending otherwise <span class="citation">(<a href="#ref-abadie2008" role="doc-biblioref">Abadie and Imbens
2008</a>)</span>. We’ll implement g-computation manually rather than
using <code><a href="https://vincentarelbundock.github.io/marginaleffects/reference/comparisons.html" class="external-link">comparisons()</a></code>, as this dramatically improves the
speed of the estimation since we don’t require standard errors to be
estimated in each sample (or other processing <code><a href="https://vincentarelbundock.github.io/marginaleffects/reference/comparisons.html" class="external-link">comparisons()</a></code>
does). We’ll consider the marginal RR ATT of <code>A</code> on the
binary outcome <code>Y_B</code>.</p>
<p>The first step is to write the estimation function, we we call
<code>boot_fun</code>. This function returns the marginal RR. In it, we
perform the matching, estimate the effect, and return the estimate of
interest.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">boot_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">boot_data</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span></span>
<span>  </span>
<span>  <span class="co">#Do 1:1 PS matching with replacement</span></span>
<span>  <span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/matchit.html">matchit</a></span><span class="op">(</span><span class="va">A</span> <span class="op">~</span> <span class="va">X1</span> <span class="op">+</span> <span class="va">X2</span> <span class="op">+</span> <span class="va">X3</span> <span class="op">+</span> <span class="va">X4</span> <span class="op">+</span> <span class="va">X5</span> <span class="op">+</span> </span>
<span>                 <span class="va">X6</span> <span class="op">+</span> <span class="va">X7</span> <span class="op">+</span> <span class="va">X8</span> <span class="op">+</span> <span class="va">X9</span>,</span>
<span>               data <span class="op">=</span> <span class="va">boot_data</span>,</span>
<span>               replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#Extract matched dataset</span></span>
<span>  <span class="va">md</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/match.data.html">match.data</a></span><span class="op">(</span><span class="va">m</span>, data <span class="op">=</span> <span class="va">boot_data</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#Fit outcome model</span></span>
<span>  <span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">Y_B</span> <span class="op">~</span> <span class="va">A</span> <span class="op">*</span> <span class="op">(</span><span class="va">X1</span> <span class="op">+</span> <span class="va">X2</span> <span class="op">+</span> <span class="va">X3</span> <span class="op">+</span> <span class="va">X4</span> <span class="op">+</span> <span class="va">X5</span> <span class="op">+</span> </span>
<span>                 <span class="va">X6</span> <span class="op">+</span> <span class="va">X7</span> <span class="op">+</span> <span class="va">X8</span> <span class="op">+</span> <span class="va">X9</span><span class="op">)</span>,</span>
<span>             data <span class="op">=</span> <span class="va">md</span>, weights <span class="op">=</span> <span class="va">weights</span>,</span>
<span>             family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">quasibinomial</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## G-computation ##</span></span>
<span>  <span class="co">#Subset to treated units for ATT; skip for ATE</span></span>
<span>  <span class="va">md1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">md</span>, <span class="va">A</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#Estimated potential outcomes under treatment</span></span>
<span>  <span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit</span>, type <span class="op">=</span> <span class="st">"response"</span>,</span>
<span>                newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform</a></span><span class="op">(</span><span class="va">md1</span>, A <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">Ep1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html" class="external-link">weighted.mean</a></span><span class="op">(</span><span class="va">p1</span>, <span class="va">md1</span><span class="op">$</span><span class="va">weights</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#Estimated potential outcomes under control</span></span>
<span>  <span class="va">p0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit</span>, type <span class="op">=</span> <span class="st">"response"</span>,</span>
<span>                newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform</a></span><span class="op">(</span><span class="va">md1</span>, A <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">Ep0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html" class="external-link">weighted.mean</a></span><span class="op">(</span><span class="va">p0</span>, <span class="va">md1</span><span class="op">$</span><span class="va">weights</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#Risk ratio</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">Ep1</span> <span class="op">/</span> <span class="va">Ep0</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Next, we call <code><a href="https://rdrr.io/pkg/boot/man/boot.html" class="external-link">boot::boot()</a></code> with this function and the
original dataset supplied to perform the bootstrapping. We’ll request
199 bootstrap replications here, but in practice you should use many
more, upwards of 999. More is always better. Using more also allows you
to use the bias-corrected and accelerated (BCa) bootstrap confidence
intervals (which you can request by setting <code>type = "bca"</code> in
the call to <code><a href="https://rdrr.io/pkg/boot/man/boot.ci.html" class="external-link">boot.ci()</a></code>), which are known to be the most
accurate. See <code><a href="https://rdrr.io/pkg/boot/man/boot.ci.html" class="external-link">?boot.ci</a></code> for details. Here, we’ll just use a
percentile confidence interval.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st">"boot"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">54321</span><span class="op">)</span></span>
<span><span class="va">boot_out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/boot/man/boot.html" class="external-link">boot</a></span><span class="op">(</span><span class="va">d</span>, <span class="va">boot_fun</span>, R <span class="op">=</span> <span class="fl">199</span><span class="op">)</span></span>
<span></span>
<span><span class="va">boot_out</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## ORDINARY NONPARAMETRIC BOOTSTRAP</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Call:</span></span>
<span><span class="co">## boot(data = d, statistic = boot_fun, R = 199)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Bootstrap Statistics :</span></span>
<span><span class="co">##     original  bias    std. error</span></span>
<span><span class="co">## t1*    1.305   0.193      0.1923</span></span></code></pre>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/boot/man/boot.ci.html" class="external-link">boot.ci</a></span><span class="op">(</span><span class="va">boot_out</span>, type <span class="op">=</span> <span class="st">"perc"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## BOOTSTRAP CONFIDENCE INTERVAL CALCULATIONS</span></span>
<span><span class="co">## Based on 199 bootstrap replicates</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## CALL : </span></span>
<span><span class="co">## boot.ci(boot.out = boot_out, type = "perc")</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Intervals : </span></span>
<span><span class="co">## Level     Percentile     </span></span>
<span><span class="co">## 95%   ( 1.163,  2.002 )  </span></span>
<span><span class="co">## Calculations and Intervals on Original Scale</span></span>
<span><span class="co">## Some percentile intervals may be unstable</span></span></code></pre>
<p>We find a RR of 1.305 with a confidence interval of (1.163, 2.002).
If we had wanted a risk difference, we could have changed the final line
in <code>boot_fun()</code> to be <code>Ep1 - Ep0</code>.</p>
</div>
<div class="section level4">
<h4 id="the-cluster-bootstrap">The cluster bootstrap<a class="anchor" aria-label="anchor" href="#the-cluster-bootstrap"></a>
</h4>
<p>For the cluster bootstrap, we need a function that takes in a vector
of subclass (e.g., pairs) and a vector of sampled pair indices and
returns the estimated quantity of interest. This function should fit the
outcome model and estimate the treatment effect using g-computation, but
the matching step occurs prior to the bootstrap. Here, we’ll use
matching without replacement, since the cluster bootstrap has been found
to work well with it <span class="citation">(<a href="#ref-austin2014" role="doc-biblioref">Austin and Small 2014</a>; <a href="#ref-abadie2019" role="doc-biblioref">Abadie and Spiess
2019</a>)</span>. This could be used for any method that returns pair
membership, including other pair matching methods without replacement
and full matching.</p>
<p>As before, we’ll use g-computation to estimate the marginal RR ATT,
and we’ll do so manually rather than using <code><a href="https://vincentarelbundock.github.io/marginaleffects/reference/comparisons.html" class="external-link">comparisons()</a></code>
for speed. Note that the cluster bootstrap is already much faster than
the standard bootstrap because matching does not need to occur within
each bootstrap sample. First, we’ll do a round of matching.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mNN</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/matchit.html">matchit</a></span><span class="op">(</span><span class="va">A</span> <span class="op">~</span> <span class="va">X1</span> <span class="op">+</span> <span class="va">X2</span> <span class="op">+</span> <span class="va">X3</span> <span class="op">+</span> <span class="va">X4</span> <span class="op">+</span> <span class="va">X5</span> <span class="op">+</span> </span>
<span>                 <span class="va">X6</span> <span class="op">+</span> <span class="va">X7</span> <span class="op">+</span> <span class="va">X8</span> <span class="op">+</span> <span class="va">X9</span>, data <span class="op">=</span> <span class="va">d</span><span class="op">)</span></span>
<span><span class="va">mNN</span></span></code></pre></div>
<pre><code><span><span class="co">## A matchit object</span></span>
<span><span class="co">##  - method: 1:1 nearest neighbor matching without replacement</span></span>
<span><span class="co">##  - distance: Propensity score</span></span>
<span><span class="co">##              - estimated with logistic regression</span></span>
<span><span class="co">##  - number of obs.: 2000 (original), 882 (matched)</span></span>
<span><span class="co">##  - target estimand: ATT</span></span>
<span><span class="co">##  - covariates: X1, X2, X3, X4, X5, X6, X7, X8, X9</span></span></code></pre>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">md</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/match.data.html">match.data</a></span><span class="op">(</span><span class="va">mNN</span><span class="op">)</span></span></code></pre></div>
<p>Next, we’ll write the function that takes in cluster membership and
the sampled indices and returns an estimate.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Unique pair IDs</span></span>
<span><span class="va">pair_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">md</span><span class="op">$</span><span class="va">subclass</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#Unit IDs, split by pair membership</span></span>
<span><span class="va">split_inds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">md</span><span class="op">)</span><span class="op">)</span>, <span class="va">md</span><span class="op">$</span><span class="va">subclass</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cluster_boot_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">pairs</span>, <span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co">#Extract units corresponding to selected pairs</span></span>
<span>  <span class="va">ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">split_inds</span><span class="op">[</span><span class="va">pairs</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#Subset md with block bootstrapped indices</span></span>
<span>  <span class="va">boot_md</span> <span class="op">&lt;-</span> <span class="va">md</span><span class="op">[</span><span class="va">ids</span>,<span class="op">]</span></span>
<span>  </span>
<span>  <span class="co">#Fit outcome model</span></span>
<span>  <span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">Y_B</span> <span class="op">~</span> <span class="va">A</span> <span class="op">*</span> <span class="op">(</span><span class="va">X1</span> <span class="op">+</span> <span class="va">X2</span> <span class="op">+</span> <span class="va">X3</span> <span class="op">+</span> <span class="va">X4</span> <span class="op">+</span> <span class="va">X5</span> <span class="op">+</span> </span>
<span>                 <span class="va">X6</span> <span class="op">+</span> <span class="va">X7</span> <span class="op">+</span> <span class="va">X8</span> <span class="op">+</span> <span class="va">X9</span><span class="op">)</span>,</span>
<span>             data <span class="op">=</span> <span class="va">boot_md</span>, weights <span class="op">=</span> <span class="va">weights</span>,</span>
<span>             family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">quasibinomial</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## G-computation ##</span></span>
<span>  <span class="co">#Subset to treated units for ATT; skip for ATE</span></span>
<span>  <span class="va">md1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">boot_md</span>, <span class="va">A</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#Estimated potential outcomes under treatment</span></span>
<span>  <span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit</span>, type <span class="op">=</span> <span class="st">"response"</span>,</span>
<span>                newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform</a></span><span class="op">(</span><span class="va">md1</span>, A <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">Ep1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html" class="external-link">weighted.mean</a></span><span class="op">(</span><span class="va">p1</span>, <span class="va">md1</span><span class="op">$</span><span class="va">weights</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#Estimated potential outcomes under control</span></span>
<span>  <span class="va">p0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit</span>, type <span class="op">=</span> <span class="st">"response"</span>,</span>
<span>                newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform</a></span><span class="op">(</span><span class="va">md1</span>, A <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">Ep0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html" class="external-link">weighted.mean</a></span><span class="op">(</span><span class="va">p0</span>, <span class="va">md1</span><span class="op">$</span><span class="va">weights</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#Risk ratio</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">Ep1</span> <span class="op">/</span> <span class="va">Ep0</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Next, we call <code><a href="https://rdrr.io/pkg/boot/man/boot.html" class="external-link">boot::boot()</a></code> with this function and the
vector of pair membership supplied to perform the bootstrapping. We’ll
request 199 bootstrap replications, but in practice you should use many
more, upwards of 999. More is always better. Using more also allows you
to use the bias-corrected and accelerated (BCa) boot strap confidence
intervals, which are known to be the most accurate. See
<code><a href="https://rdrr.io/pkg/boot/man/boot.ci.html" class="external-link">?boot.ci</a></code> for details. Here, we’ll just use a percentile
confidence interval.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st">"boot"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">54321</span><span class="op">)</span></span>
<span><span class="va">cluster_boot_out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/boot/man/boot.html" class="external-link">boot</a></span><span class="op">(</span><span class="va">pair_ids</span>, <span class="va">cluster_boot_fun</span>,</span>
<span>                         R <span class="op">=</span> <span class="fl">199</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cluster_boot_out</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## ORDINARY NONPARAMETRIC BOOTSTRAP</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Call:</span></span>
<span><span class="co">## boot(data = pair_ids, statistic = cluster_boot_fun, R = 199)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Bootstrap Statistics :</span></span>
<span><span class="co">##     original   bias    std. error</span></span>
<span><span class="co">## t1*    1.549 0.005733      0.1234</span></span></code></pre>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/boot/man/boot.ci.html" class="external-link">boot.ci</a></span><span class="op">(</span><span class="va">cluster_boot_out</span>, type <span class="op">=</span> <span class="st">"perc"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## BOOTSTRAP CONFIDENCE INTERVAL CALCULATIONS</span></span>
<span><span class="co">## Based on 199 bootstrap replicates</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## CALL : </span></span>
<span><span class="co">## boot.ci(boot.out = cluster_boot_out, type = "perc")</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Intervals : </span></span>
<span><span class="co">## Level     Percentile     </span></span>
<span><span class="co">## 95%   ( 1.331,  1.838 )  </span></span>
<span><span class="co">## Calculations and Intervals on Original Scale</span></span>
<span><span class="co">## Some percentile intervals may be unstable</span></span></code></pre>
<p>We find a RR of 1.549 with a confidence interval of (1.331, 1.838).
If we had wanted a risk difference, we could have changed the final line
in <code>cluster_boot_fun()</code> to be <code>Ep1 - Ep0</code>.</p>
</div>
</div>
<div class="section level3">
<h3 id="moderation-analysis">Moderation Analysis<a class="anchor" aria-label="anchor" href="#moderation-analysis"></a>
</h3>
<p>Moderation analysis involves determining whether a treatment effect
differs across levels of another variable. The use of matching with
moderation analysis is described in <span class="citation">Green and
Stuart (<a href="#ref-greenExaminingModerationAnalyses2014" role="doc-biblioref">2014</a>)</span>. The goal is to achieve balance
within each subgroup of the potential moderating variable, and there are
several ways of doing so. Broadly, one can either perform matching in
the full dataset, requiring exact matching on the moderator, or one can
perform completely separate analyses in each subgroup. We’ll demonstrate
the first approach below; see the blog post <a href="https://ngreifer.github.io/blog/subgroup-analysis-psm/" class="external-link">“Subgroup
Analysis After Propensity Score Matching Using R”</a> by Noah Greifer
for an example of the other approach.</p>
<p>There are benefits to using either approach, and <span class="citation">Green and Stuart (<a href="#ref-greenExaminingModerationAnalyses2014" role="doc-biblioref">2014</a>)</span> find that either can be successful
at balancing the subgroups. The first approach may be most effective
with small samples, where separate propensity score models would be fit
with greater uncertainty and an increased possibility of perfect
prediction or failure to converge <span class="citation">(<a href="#ref-wangRelativePerformancePropensity2018" role="doc-biblioref">Wang et al. 2018</a>)</span>. The second approach
may be more effective with larger samples or with matching methods that
target balance in the matched sample, such as genetic matching <span class="citation">(<a href="#ref-kreifMethodsEstimatingSubgroup2012" role="doc-biblioref">Kreif et al. 2012</a>)</span>. With genetic
matching, separate subgroup analyses ensure balance is optimized within
each subgroup rather than just overall. The chosen approach should be
that which achieves the best balance, though we don’t demonstrate
assessing balance here to maintain focus on effect estimation.</p>
<p>The full dataset approach involves pooling information across
subgroups. This could involve estimating propensity scores using a
single model for both groups but exact matching on the potential
moderator. The propensity score model could include
moderator-by-covariate interactions to allow the propensity score model
to vary across subgroups on some covariates. It is critical that exact
matching is done on the moderator so that matched pairs are not split
across subgroups.</p>
<p>We’ll consider the binary variable <code>X5</code> to be the
potential moderator of the effect of <code>A</code> on <code>Y_C</code>.
Below, we’ll estimate a propensity score using a single propensity score
model with a few moderator-by-covariate interactions. We’ll perform
nearest neighbor matching on the propensity score and exact matching on
the moderator, <code>X5</code>.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mP</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/matchit.html">matchit</a></span><span class="op">(</span><span class="va">A</span> <span class="op">~</span> <span class="va">X1</span> <span class="op">+</span> <span class="va">X2</span> <span class="op">+</span> <span class="va">X5</span><span class="op">*</span><span class="va">X3</span> <span class="op">+</span> <span class="va">X4</span> <span class="op">+</span> </span>
<span>                <span class="va">X5</span><span class="op">*</span><span class="va">X6</span> <span class="op">+</span> <span class="va">X7</span> <span class="op">+</span> <span class="va">X5</span><span class="op">*</span><span class="va">X8</span> <span class="op">+</span> <span class="va">X9</span>, data <span class="op">=</span> <span class="va">d</span>,</span>
<span>              exact <span class="op">=</span> <span class="op">~</span><span class="va">X5</span>, method <span class="op">=</span> <span class="st">"nearest"</span><span class="op">)</span></span>
<span><span class="va">mP</span></span></code></pre></div>
<pre><code><span><span class="co">## A matchit object</span></span>
<span><span class="co">##  - method: 1:1 nearest neighbor matching without replacement</span></span>
<span><span class="co">##  - distance: Propensity score</span></span>
<span><span class="co">##              - estimated with logistic regression</span></span>
<span><span class="co">##  - number of obs.: 2000 (original), 882 (matched)</span></span>
<span><span class="co">##  - target estimand: ATT</span></span>
<span><span class="co">##  - covariates: X1, X2, X5, X3, X4, X6, X7, X8, X9</span></span></code></pre>
<p>Although it is straightforward to assess balance overall using
<code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code>, it is more challenging to assess balance within
subgroups. The easiest way to check subgroup balance would be to use
<code><a href="https://ngreifer.github.io/cobalt/reference/bal.tab.html" class="external-link">cobalt::bal.tab()</a></code>, which has a <code>cluster</code>
argument that can be used to assess balance within subgroups, e.g., by
<code>cobalt::bal.tab(mP, cluster = "X5")</code>. See the vignette
“Appendix 2: Using cobalt with Clustered, Multiply Imputed, and Other
Segmented Data” on the <code>cobalt</code> <a href="https://ngreifer.github.io/cobalt/index.html" class="external-link">website</a> or at
<code><a href="https://ngreifer.github.io/cobalt/articles/cobalt_A2_segmented_data.html" class="external-link">vignette("cobalt_A2_segmented_data", package = "cobalt")</a></code>
for details.</p>
<p>If we are satisfied with balance, we can then model the outcome with
an interaction between the treatment and the moderator.</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mdP</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/match.data.html">match.data</a></span><span class="op">(</span><span class="va">mP</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fitP</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">Y_C</span> <span class="op">~</span> <span class="va">A</span> <span class="op">*</span> <span class="va">X5</span>, data <span class="op">=</span> <span class="va">mdP</span>, weights <span class="op">=</span> <span class="va">weights</span><span class="op">)</span></span></code></pre></div>
<p>To estimate the subgroup ATTs, we can use <code><a href="https://vincentarelbundock.github.io/marginaleffects/reference/comparisons.html" class="external-link">comparisons()</a></code>,
this time specifying the <code>by</code> argument to signify that we
want treatment effects stratified by the moderator.</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">comp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://vincentarelbundock.github.io/marginaleffects/reference/comparisons.html" class="external-link">comparisons</a></span><span class="op">(</span><span class="va">fitP</span>, variables <span class="op">=</span> <span class="st">"A"</span>,</span>
<span>                    vcov <span class="op">=</span> <span class="op">~</span><span class="va">subclass</span>,</span>
<span>                    newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">md</span>, <span class="va">A</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>                    wts <span class="op">=</span> <span class="st">"weights"</span>,</span>
<span>                    by <span class="op">=</span> <span class="st">"X5"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">comp</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   Term          Contrast X5 Effect Std. Error z value Pr(&gt;|z|) 2.5 % 97.5 %</span></span>
<span><span class="co">## 1    A mean(1) - mean(0)  1   1.77      0.566    3.12  0.00181 0.657   2.88</span></span>
<span><span class="co">## 2    A mean(1) - mean(0)  0   2.17      0.650    3.33  0.00086 0.892   3.44</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Model type:  lm </span></span>
<span><span class="co">## Prediction type:  response</span></span></code></pre>
<p>We can see that the subgroup mean differences are quite similar to
each other. Finally, we can test for moderation using another call to
<code><a href="https://vincentarelbundock.github.io/marginaleffects/reference/comparisons.html" class="external-link">comparisons()</a></code>, this time using the <code>hypothesis</code>
argument to signify that we want to compare effects between
subgroups:</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">comp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://vincentarelbundock.github.io/marginaleffects/reference/comparisons.html" class="external-link">comparisons</a></span><span class="op">(</span><span class="va">fitP</span>, variables <span class="op">=</span> <span class="st">"A"</span>,</span>
<span>                    vcov <span class="op">=</span> <span class="op">~</span><span class="va">subclass</span>,</span>
<span>                    newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">md</span>, <span class="va">A</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>                    wts <span class="op">=</span> <span class="st">"weights"</span>,</span>
<span>                    by <span class="op">=</span> <span class="st">"X5"</span>,</span>
<span>                    hypothesis <span class="op">=</span> <span class="st">"pairwise"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">comp</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    Term Effect Std. Error z value Pr(&gt;|z|) 2.5 % 97.5 %</span></span>
<span><span class="co">## 1 1 - 0 -0.399      0.862  -0.463     0.64 -2.09   1.29</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Model type:  lm </span></span>
<span><span class="co">## Prediction type:  response</span></span></code></pre>
<p>As expected, the difference between the subgroup treatment effects is
small and nonsignificant, so there is no evidence of moderation by
<code>X5</code>.</p>
</div>
<div class="section level3">
<h3 id="reporting-results">Reporting Results<a class="anchor" aria-label="anchor" href="#reporting-results"></a>
</h3>
<p>It is important to be as thorough and complete as possible when
describing the methods of estimating the treatment effect and the
results of the analysis. This improves transparency and replicability of
the analysis. Results should at least include the following:</p>
<ul>
<li>a description of the outcome model used (e.g., logistic regression,
a linear model with treatment-covariate interactions and covariates, a
Cox proportional hazards model with the matching weights applied)</li>
<li>the way the effect was estimated (e.g., using g-computation or as
the coefficient in the outcome model)</li>
<li>the way SEs and confidence intervals were estimated (e.g., using
robust SEs, using cluster-robust SEs with pair membership as the
cluster, using the BCa bootstrap with 4999 bootstrap replications and
the entire process of matching and effect estimation included in each
replication)</li>
<li>R packages and functions used in estimating the effect and its SE
(e.g., <code><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm()</a></code> in base R, <code><a href="https://vincentarelbundock.github.io/marginaleffects/reference/comparisons.html" class="external-link">comparisons()</a></code> in
<code>marginaleffects</code>, <code><a href="https://rdrr.io/pkg/boot/man/boot.html" class="external-link">boot()</a></code> and
<code><a href="https://rdrr.io/pkg/boot/man/boot.ci.html" class="external-link">boot.ci()</a></code> in <code>boot</code>)</li>
<li>The effect and its SE and confidence interval</li>
</ul>
<p>All this is in addition to information about the matching method,
propensity score estimation procedure (if used), balance assessment,
etc. mentioned in the other vignettes.</p>
</div>
</div>
<div class="section level2">
<h2 id="common-mistakes">Common Mistakes<a class="anchor" aria-label="anchor" href="#common-mistakes"></a>
</h2>
<p>There are a few common mistakes that should be avoided. It is
important not only to avoid these mistakes in one’s own research but
also to be able to spot these mistakes in others’ analyses.</p>
<div class="section level3">
<h3 id="failing-to-include-weights">1. Failing to include weights<a class="anchor" aria-label="anchor" href="#failing-to-include-weights"></a>
</h3>
<p>Several methods involve weights that are to be used in estimating the
treatment effect. With full matching and stratification matching (when
analyzed using MMWS), the weights do the entire work of balancing the
covariates across the treatment groups. Omitting weights essentially
ignores the entire purpose of matching. Some cases are less obvious.
When performing matching with replacement and estimating the treatment
effect using the <code><a href="../reference/match.data.html">match.data()</a></code> output, weights must be
included to ensure control units matched to multiple treated units are
weighted accordingly. Similarly, when performing k:1 matching where not
all treated units receive k matches, weights are required to account for
the differential weight of the matched control units. The only time
weights can be omitted after pair matching is when performing 1:1
matching without replacement. Including weights even in this scenario
will not affect the analysis and it can be good practice to always
include weights to prevent this error from occurring. There are some
scenarios where weights are not useful because the conditioning occurs
through some other means, such as when using the direct subclass
strategy rather than MMWS for estimating marginal effects after
stratification.</p>
</div>
<div class="section level3">
<h3 id="failing-to-use-robust-or-cluster-robust-standard-errors">2. Failing to use robust or cluster-robust standard errors<a class="anchor" aria-label="anchor" href="#failing-to-use-robust-or-cluster-robust-standard-errors"></a>
</h3>
<p>Robust SEs are required when using weights to estimate the treatment
effect. The model-based SEs resulting from weighted least squares or
maximum likelihood are inaccurate when using matching weights because
they assume weights are frequency weights rather than probability
weights. Cluster-robust SEs account for both the matching weights and
pair membership and should be used when appropriate. Sometimes,
researchers use functions in the <code>survey</code> package to estimate
robust SEs, especially with inverse probability weighting; this is a
valid way to compute robust SEs and will give similar results to
<code><a href="https://sandwich.R-Forge.R-project.org/reference/vcovHC.html" class="external-link">sandwich::vcovHC()</a></code>.<a href="#fn10" class="footnote-ref" id="fnref10"><sup>10</sup></a></p>
</div>
<div class="section level3">
<h3 id="interpreting-conditional-effects-as-marginal-effects">3. Interpreting conditional effects as marginal effects<a class="anchor" aria-label="anchor" href="#interpreting-conditional-effects-as-marginal-effects"></a>
</h3>
<p>The distinction between marginal and conditional effects is not
always clear both in methodological and applied papers. Some statistical
methods are valid only for estimating conditional effects and they
should not be used to estimate marginal effects (without further
modification). Sometimes conditional effects are desirable, and such
methods may be useful for them, but when marginal effects are the target
of inference, it is critical not to inappropriately interpret estimates
resulting from statistical methods aimed at estimating conditional
effects as marginal effects. Although this issue is particularly salient
with binary and survival outcomes due to the general noncollapsibility
of the OR, RR, and HR, this can also occur with linear models for
continuous outcomes or the RD.</p>
<p>The following methods estimate <strong>conditional effects</strong>
for binary or survival outcomes (with noncollapsible effect measures)
and should <strong>not</strong> be used to estimate marginal
effects:</p>
<ul>
<li>Logistic regression or Cox proportional hazards model with
covariates and/or the propensity score included, using the coefficient
on treatment as the effect estimate</li>
<li>Conditional logistic regression after matching</li>
<li>Stratified Cox regression after matching</li>
<li>Averaging stratum-specific effect estimates after stratification,
including using Mantel-Haenszel OR pooling</li>
<li>Including pair or stratum fixed or random effects in a logistic
regression model, using the coefficient on treatment as the effect
estimate</li>
</ul>
<p>In addition, with continuous outcomes, conditional effects can be
mistakenly interpreted as marginal effect estimates when
treatment-covariate interactions are present in the outcome model. If
the covariates are not centered at their mean in the target population
(e.g., the treated group for the ATT, the full sample for the ATE, or
the remaining matched sample for an ATM), the coefficient on treatment
will not correspond to the marginal effect in the target population; it
will correspond to the effect of treatment when the covariate values are
equal to zero, which may not be meaningful or plausible. G-computation
is always the safest way to estimate effects when including covariates
in the outcome model, especially in the presence of treatment-covariate
interactions.</p>
</div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-abadie2008" class="csl-entry">
Abadie, Alberto, and Guido W. Imbens. 2008. <span>“On the Failure of the
Bootstrap for Matching Estimators.”</span> <em>Econometrica</em> 76 (6):
1537–57. <a href="https://doi.org/10.3982/ECTA6474" class="external-link">https://doi.org/10.3982/ECTA6474</a>.
</div>
<div id="ref-abadie2019" class="csl-entry">
Abadie, Alberto, and Jann Spiess. 2019. <span>“Robust Post-Matching
Inference,”</span> January, 34. <a href="https://doi.org/10.1080/01621459.2020.1840383" class="external-link">https://doi.org/10.1080/01621459.2020.1840383</a>.
</div>
<div id="ref-austin2009a" class="csl-entry">
Austin, Peter C. 2009. <span>“Type i Error Rates, Coverage of Confidence
Intervals, and Variance Estimation in Propensity-Score Matched
Analyses.”</span> <em>The International Journal of Biostatistics</em> 5
(1). <a href="https://doi.org/10.2202/1557-4679.1146" class="external-link">https://doi.org/10.2202/1557-4679.1146</a>.
</div>
<div id="ref-austin2013" class="csl-entry">
———. 2013a. <span>“The Performance of Different Propensity Score Methods
for Estimating Marginal Hazard Ratios.”</span> <em>Statistics in
Medicine</em> 32 (16): 2837–49. <a href="https://doi.org/10.1002/sim.5705" class="external-link">https://doi.org/10.1002/sim.5705</a>.
</div>
<div id="ref-austin2013a" class="csl-entry">
———. 2013b. <span>“The Use of Propensity Score Methods with Survival or
Time-to-Event Outcomes: Reporting Measures of Effect Similar to Those
Used in Randomized Experiments.”</span> <em>Statistics in Medicine</em>
33 (7): 1242–58. <a href="https://doi.org/10.1002/sim.5984" class="external-link">https://doi.org/10.1002/sim.5984</a>.
</div>
<div id="ref-austinDoublePropensityscoreAdjustment2017" class="csl-entry">
———. 2017. <span>“Double Propensity-Score Adjustment: A Solution to
Design Bias or Bias Due to Incomplete Matching.”</span> <em>Statistical
Methods in Medical Research</em> 26 (1): 201–22. <a href="https://doi.org/10.1177/0962280214543508" class="external-link">https://doi.org/10.1177/0962280214543508</a>.
</div>
<div id="ref-austin2020a" class="csl-entry">
Austin, Peter C., and Guy Cafri. 2020. <span>“Variance Estimation When
Using Propensity<span>-</span>Score Matching with Replacement with
Survival or Time<span>-</span>to<span>-</span>Event Outcomes.”</span>
<em>Statistics in Medicine</em> 39 (11): 1623–40. <a href="https://doi.org/10.1002/sim.8502" class="external-link">https://doi.org/10.1002/sim.8502</a>.
</div>
<div id="ref-austin2014" class="csl-entry">
Austin, Peter C., and Dylan S. Small. 2014. <span>“The Use of
Bootstrapping When Using Propensity-Score Matching Without Replacement:
A Simulation Study.”</span> <em>Statistics in Medicine</em> 33 (24):
4306–19. <a href="https://doi.org/10.1002/sim.6276" class="external-link">https://doi.org/10.1002/sim.6276</a>.
</div>
<div id="ref-austin2017" class="csl-entry">
Austin, Peter C., and Elizabeth A. Stuart. 2017. <span>“Estimating the
Effect of Treatment on Binary Outcomes Using Full Matching on the
Propensity Score.”</span> <em>Statistical Methods in Medical
Research</em> 26 (6): 2505–25. <a href="https://doi.org/10.1177/0962280215601134" class="external-link">https://doi.org/10.1177/0962280215601134</a>.
</div>
<div id="ref-austin2020" class="csl-entry">
Austin, Peter C., Neal Thomas, and Donald B. Rubin. 2020.
<span>“Covariate-Adjusted Survival Analyses in Propensity-Score Matched
Samples: Imputing Potential Time-to-Event Outcomes.”</span>
<em>Statistical Methods in Medical Research</em> 29 (3): 728–51. <a href="https://doi.org/10.1177/0962280218817926" class="external-link">https://doi.org/10.1177/0962280218817926</a>.
</div>
<div id="ref-bodory2020" class="csl-entry">
Bodory, Hugo, Lorenzo Camponovo, Martin Huber, and Michael Lechner.
2020. <span>“The Finite Sample Performance of Inference Methods for
Propensity Score Matching and Weighting Estimators.”</span> <em>Journal
of Business &amp; Economic Statistics</em> 38 (1): 183–200. <a href="https://doi.org/10.1080/07350015.2018.1476247" class="external-link">https://doi.org/10.1080/07350015.2018.1476247</a>.
</div>
<div id="ref-cameron2015" class="csl-entry">
Cameron, A. Colin, and Douglas L. Miller. 2015. <span>“A
Practitioner<span>’</span>s Guide to Cluster-Robust Inference.”</span>
<em>Journal of Human Resources</em> 50 (2): 317–72. <a href="https://doi.org/10.3368/jhr.50.2.317" class="external-link">https://doi.org/10.3368/jhr.50.2.317</a>.
</div>
<div id="ref-carpenter2000" class="csl-entry">
Carpenter, James, and John Bithell. 2000. <span>“Bootstrap Confidence
Intervals: When, Which, What? A Practical Guide for Medical
Statisticians.”</span> <em>Statistics in Medicine</em> 19 (9): 1141–64.
<a href="https://doi.org/10.1002/(SICI)1097-0258(20000515)19:9&lt;1141::AID-SIM479&gt;3.0.CO;2-F" class="external-link">https://doi.org/10.1002/(SICI)1097-0258(20000515)19:9&lt;1141::AID-SIM479&gt;3.0.CO;2-F</a>.
</div>
<div id="ref-desai2017" class="csl-entry">
Desai, Rishi J., Kenneth J. Rothman, Brian T. Bateman, Sonia
Hernandez-Diaz, and Krista F. Huybrechts. 2017. <span>“A
Propensity-Score-Based Fine Stratification Approach for Confounding
Adjustment When Exposure Is Infrequent:”</span> <em>Epidemiology</em> 28
(2): 249–57. <a href="https://doi.org/10.1097/EDE.0000000000000595" class="external-link">https://doi.org/10.1097/EDE.0000000000000595</a>.
</div>
<div id="ref-efron1993" class="csl-entry">
Efron, Bradley, and Robert J. Tibshirani. 1993. <em>An Introduction to
the Bootstrap</em>. Springer US.
</div>
<div id="ref-gayat2012" class="csl-entry">
Gayat, Etienne, Matthieu Resche-Rigon, Jean-Yves Mary, and Raphaël
Porcher. 2012. <span>“Propensity Score Applied to Survival Data Analysis
Through Proportional Hazards Models: A Monte Carlo Study.”</span>
<em>Pharmaceutical Statistics</em> 11 (3): 222–29. <a href="https://doi.org/10.1002/pst.537" class="external-link">https://doi.org/10.1002/pst.537</a>.
</div>
<div id="ref-greenExaminingModerationAnalyses2014" class="csl-entry">
Green, Kerry M., and Elizabeth A. Stuart. 2014. <span>“Examining
Moderation Analyses in Propensity Score Methods:
<span>Application</span> to Depression and Substance Use.”</span>
<em>Journal of Consulting and Clinical Psychology</em>, Advances in
<span>Data Analytic Methods</span>, 82 (5): 773–83. <a href="https://doi.org/10.1037/a0036515" class="external-link">https://doi.org/10.1037/a0036515</a>.
</div>
<div id="ref-greiferChoosingEstimandWhen2021" class="csl-entry">
Greifer, Noah, and Elizabeth A. Stuart. 2021. <span>“Choosing the
<span>Estimand When Matching</span> or <span>Weighting</span> in
<span>Observational Studies</span>.”</span> <em>arXiv:2106.10577
[Stat]</em>, June. <a href="https://arxiv.org/abs/2106.10577" class="external-link">https://arxiv.org/abs/2106.10577</a>.
</div>
<div id="ref-hill2006" class="csl-entry">
Hill, Jennifer, and Jerome P. Reiter. 2006. <span>“Interval Estimation
for Treatment Effects Using Propensity Score Matching.”</span>
<em>Statistics in Medicine</em> 25 (13): 2230–56. <a href="https://doi.org/10.1002/sim.2277" class="external-link">https://doi.org/10.1002/sim.2277</a>.
</div>
<div id="ref-ho2007" class="csl-entry">
Ho, Daniel E., Kosuke Imai, Gary King, and Elizabeth A. Stuart. 2007.
<span>“Matching as Nonparametric Preprocessing for Reducing Model
Dependence in Parametric Causal Inference.”</span> <em>Political
Analysis</em> 15 (3): 199–236. <a href="https://doi.org/10.1093/pan/mpl013" class="external-link">https://doi.org/10.1093/pan/mpl013</a>.
</div>
<div id="ref-hong2010" class="csl-entry">
Hong, Guanglei. 2010. <span>“Marginal Mean Weighting Through
Stratification: Adjustment for Selection Bias in Multilevel
Data.”</span> <em>Journal of Educational and Behavioral Statistics</em>
35 (5): 499–531. <a href="https://doi.org/10.3102/1076998609359785" class="external-link">https://doi.org/10.3102/1076998609359785</a>.
</div>
<div id="ref-king2015" class="csl-entry">
King, Gary, and Margaret E. Roberts. 2015. <span>“How Robust Standard
Errors Expose Methodological Problems They Do Not Fix, and What to Do
About It.”</span> <em>Political Analysis</em> 23 (2): 159–79. <a href="https://doi.org/10.1093/pan/mpu015" class="external-link">https://doi.org/10.1093/pan/mpu015</a>.
</div>
<div id="ref-kreifMethodsEstimatingSubgroup2012" class="csl-entry">
Kreif, Noemi, Richard Grieve, Rosalba Radice, Zia Sadique, Roland
Ramsahai, and Jasjeet S. Sekhon. 2012. <span>“Methods for Estimating
Subgroup Effects in Cost-Effectiveness Analyses That Use Observational
Data.”</span> <em>Medical Decision Making</em> 32 (6): 750–63. <a href="https://doi.org/10.1177/0272989X12448929" class="external-link">https://doi.org/10.1177/0272989X12448929</a>.
</div>
<div id="ref-liang1986" class="csl-entry">
Liang, Kung-Yee, and Scott L. Zeger. 1986. <span>“Longitudinal Data
Analysis Using Generalized Linear Models.”</span> <em>Biometrika</em> 73
(1): 13–22. <a href="https://doi.org/10.1093/biomet/73.1.13" class="external-link">https://doi.org/10.1093/biomet/73.1.13</a>.
</div>
<div id="ref-mackinnon2006" class="csl-entry">
MacKinnon, James G. 2006. <span>“Bootstrap Methods in
Econometrics*.”</span> <em>Economic Record</em> 82 (s1): S2–18. <a href="https://doi.org/10.1111/j.1475-4932.2006.00328.x" class="external-link">https://doi.org/10.1111/j.1475-4932.2006.00328.x</a>.
</div>
<div id="ref-mackinnon1985" class="csl-entry">
MacKinnon, James G., and Halbert White. 1985. <span>“Some
Heteroskedasticity-Consistent Covariance Matrix Estimators with Improved
Finite Sample Properties.”</span> <em>Journal of Econometrics</em> 29
(3): 305–25. <a href="https://doi.org/10.1016/0304-4076(85)90158-7" class="external-link">https://doi.org/10.1016/0304-4076(85)90158-7</a>.
</div>
<div id="ref-nguyen2017" class="csl-entry">
Nguyen, Tri-Long, Gary S. Collins, Jessica Spence, Jean-Pierre Daurès,
P. J. Devereaux, Paul Landais, and Yannick Le Manach. 2017.
<span>“Double-Adjustment in Propensity Score Matching Analysis: Choosing
a Threshold for Considering Residual Imbalance.”</span> <em>BMC Medical
Research Methodology</em> 17: 78. <a href="https://doi.org/10.1186/s12874-017-0338-0" class="external-link">https://doi.org/10.1186/s12874-017-0338-0</a>.
</div>
<div id="ref-schaferAverageCausalEffects2008" class="csl-entry">
Schafer, Joseph L., and Joseph Kang. 2008. <span>“Average Causal Effects
from Nonrandomized Studies: A Practical Guide and Simulated
Example.”</span> <em>Psychological Methods</em> 13 (4): 279–313. <a href="https://doi.org/10.1037/a0014268" class="external-link">https://doi.org/10.1037/a0014268</a>.
</div>
<div id="ref-snowdenImplementationGComputationSimulated2011" class="csl-entry">
Snowden, Jonathan M., Sherri Rose, and Kathleen M. Mortimer. 2011.
<span>“Implementation of G-Computation on a Simulated Data Set:
Demonstration of a Causal Inference Technique.”</span> <em>American
Journal of Epidemiology</em> 173 (7): 731–38. <a href="https://doi.org/10.1093/aje/kwq472" class="external-link">https://doi.org/10.1093/aje/kwq472</a>.
</div>
<div id="ref-wan2019" class="csl-entry">
Wan, Fei. 2019. <span>“Matched or Unmatched Analyses with
Propensity<span>-</span>Score<span></span>matched Data?”</span>
<em>Statistics in Medicine</em> 38 (2): 289–300. <a href="https://doi.org/10.1002/sim.7976" class="external-link">https://doi.org/10.1002/sim.7976</a>.
</div>
<div id="ref-wangRelativePerformancePropensity2018" class="csl-entry">
Wang, Shirley V., Yinzhu Jin, Bruce Fireman, Susan Gruber, Mengdong He,
Richard Wyss, HoJin Shin, et al. 2018. <span>“Relative
<span>Performance</span> of <span>Propensity Score Matching
Strategies</span> for <span>Subgroup Analyses</span>.”</span>
<em>American Journal of Epidemiology</em> 187 (8): 1799–1807. <a href="https://doi.org/10.1093/aje/kwy049" class="external-link">https://doi.org/10.1093/aje/kwy049</a>.
</div>
<div id="ref-westreich2013" class="csl-entry">
Westreich, D., and S. Greenland. 2013. <span>“The Table 2 Fallacy:
Presenting and Interpreting Confounder and Modifier
Coefficients.”</span> <em>American Journal of Epidemiology</em> 177 (4):
292–98. <a href="https://doi.org/10.1093/aje/kws412" class="external-link">https://doi.org/10.1093/aje/kws412</a>.
</div>
</div>
</div>
<div class="section level2">
<h2 id="code-to-generate-data-used-in-examples">Code to Generate Data used in Examples<a class="anchor" aria-label="anchor" href="#code-to-generate-data-used-in-examples"></a>
</h2>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Generating data similar to Austin (2009) for demonstrating treatment effect estimation</span></span>
<span><span class="va">gen_X</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">9</span> <span class="op">*</span> <span class="va">n</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="va">n</span>, ncol <span class="op">=</span> <span class="fl">9</span><span class="op">)</span></span>
<span>  <span class="va">X</span><span class="op">[</span>,<span class="fl">5</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">X</span><span class="op">[</span>,<span class="fl">5</span><span class="op">]</span> <span class="op">&lt;</span> <span class="fl">.5</span><span class="op">)</span></span>
<span>  <span class="va">X</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#~20% treated</span></span>
<span><span class="va">gen_A</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">X</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">LP_A</span> <span class="op">&lt;-</span> <span class="op">-</span> <span class="fl">1.2</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1.5</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">4</span><span class="op">]</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2.4</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">5</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">7</span><span class="op">]</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1.5</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">8</span><span class="op">]</span></span>
<span>  <span class="va">P_A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="va">LP_A</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, <span class="fl">1</span>, <span class="va">P_A</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Continuous outcome</span></span>
<span><span class="va">gen_Y_C</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">A</span>, <span class="va">X</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fl">2</span><span class="op">*</span><span class="va">A</span> <span class="op">+</span> <span class="fl">2</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="fl">2</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="fl">2</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">4</span><span class="op">]</span> <span class="op">+</span> <span class="fl">2</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">5</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">6</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span>, <span class="fl">0</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#Conditional:</span></span>
<span><span class="co">#  MD: 2</span></span>
<span><span class="co">#Marginal:</span></span>
<span><span class="co">#  MD: 2</span></span>
<span></span>
<span><span class="co"># Binary outcome</span></span>
<span><span class="va">gen_Y_B</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">A</span>, <span class="va">X</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">LP_B</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">2</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2.4</span><span class="op">)</span><span class="op">*</span><span class="va">A</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1.5</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">4</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2.4</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">5</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1.5</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">6</span><span class="op">]</span></span>
<span>  <span class="va">P_B</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="va">LP_B</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span>, <span class="fl">1</span>, <span class="va">P_B</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#Conditional:</span></span>
<span><span class="co">#  OR:   2.4</span></span>
<span><span class="co">#  logOR: .875</span></span>
<span><span class="co">#Marginal:</span></span>
<span><span class="co">#  RD:    .144</span></span>
<span><span class="co">#  RR:   1.54</span></span>
<span><span class="co">#  logRR: .433</span></span>
<span><span class="co">#  OR:   1.92</span></span>
<span><span class="co">#  logOR  .655</span></span>
<span></span>
<span><span class="co"># Survival outcome</span></span>
<span><span class="va">gen_Y_S</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">A</span>, <span class="va">X</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">LP_S</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">2</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2.4</span><span class="op">)</span><span class="op">*</span><span class="va">A</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1.5</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">4</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2.4</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">5</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1.5</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">6</span><span class="op">]</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">*</span><span class="fl">2e4</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">LP_S</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#Conditional:</span></span>
<span><span class="co">#  HR:   2.4</span></span>
<span><span class="co">#  logHR: .875</span></span>
<span><span class="co">#Marginal:</span></span>
<span><span class="co">#  HR:   1.57</span></span>
<span><span class="co">#  logHR: .452</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">19599</span><span class="op">)</span></span>
<span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">2000</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu">gen_X</span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">A</span> <span class="op">&lt;-</span> <span class="fu">gen_A</span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Y_C</span> <span class="op">&lt;-</span> <span class="fu">gen_Y_C</span><span class="op">(</span><span class="va">A</span>, <span class="va">X</span><span class="op">)</span></span>
<span><span class="va">Y_B</span> <span class="op">&lt;-</span> <span class="fu">gen_Y_B</span><span class="op">(</span><span class="va">A</span>, <span class="va">X</span><span class="op">)</span></span>
<span><span class="va">Y_S</span> <span class="op">&lt;-</span> <span class="fu">gen_Y_S</span><span class="op">(</span><span class="va">A</span>, <span class="va">X</span><span class="op">)</span></span>
<span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">A</span>, <span class="va">X</span>, <span class="va">Y_C</span>, <span class="va">Y_B</span>, <span class="va">Y_S</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="footnotes footnotes-end-of-document">
<hr>
<ol>
<li id="fn1"><p>Because they are only appropriate with a large number of
clusters, cluster-robust SEs are generally not used with
subclassification methods. Regular robust SEs are valid with these
methods when using the subclassification weights to estimate marginal
effects.<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
<li id="fn2"><p>Sometimes, an error will occur with this method, which
usually means more bootstrap replications are required. The number of
replicates must be greater than the original sample size when using the
full bootstrap and greater than the number of pairs/strata when using
the block bootstrap.<a href="#fnref2" class="footnote-back">↩︎</a></p></li>
<li id="fn3"><p>The matching weights are not necessary when performing
1:1 matching, but we include them here for generality. When weights are
not necessary, including them does not affect the estimates. Because it
may not always be clear when weights are required, we recommend always
including them.<a href="#fnref3" class="footnote-back">↩︎</a></p></li>
<li id="fn4"><p>To verify that they are equal, add the argument
<code>hypothesis = "revpairwise"</code> to the call to
<code><a href="https://vincentarelbundock.github.io/marginaleffects/reference/predictions.html" class="external-link">predictions()</a></code>; this explicitly compares the average
potential outcomes and should yield identical estimates to the
<code><a href="https://vincentarelbundock.github.io/marginaleffects/reference/comparisons.html" class="external-link">comparisons()</a></code> call.<a href="#fnref4" class="footnote-back">↩︎</a></p></li>
<li id="fn5"><p>It is also known as fine stratification weighting,
described by <span class="citation">Desai et al. (<a href="#ref-desai2017" role="doc-biblioref">2017</a>)</span>.<a href="#fnref5" class="footnote-back">↩︎</a></p></li>
<li id="fn6"><p>We use <code><a href="https://rdrr.io/r/stats/family.html" class="external-link">quasibinomial()</a></code> instead of
<code><a href="https://rdrr.io/r/stats/family.html" class="external-link">binomial()</a></code> simply to avoid a spurious warning that can
occur with certain kinds of matching; the results will be identical
regardless.<a href="#fnref6" class="footnote-back">↩︎</a></p></li>
<li id="fn7"><p>Note that for low or high average expected risks
computed with <code><a href="https://vincentarelbundock.github.io/marginaleffects/reference/predictions.html" class="external-link">predictions()</a></code>, the confidence intervals may
go below 0 or above 1; this is because an approximation is used. To
avoid this problem, bootstrapping or simulation-based inference can be
used instead.<a href="#fnref7" class="footnote-back">↩︎</a></p></li>
<li id="fn8"><p>It is not immediately clear how to estimate a marginal
HR when covariates are included in the outcome model; though <span class="citation">Austin, Thomas, and Rubin (<a href="#ref-austin2020" role="doc-biblioref">2020</a>)</span> describe several ways of including
covariates in a model to estimate the marginal HR, they do not develop
SEs and little research has been done on this method, so we will not
present it here. Instead, we fit a simple Cox model with the treatment
as the sole predictor.<a href="#fnref8" class="footnote-back">↩︎</a></p></li>
<li id="fn9"><p>For subclassification, only MMWS can be used; this is
done simply by including the stratification weights in the Cox model and
omitting the <code>cluster</code> argument.<a href="#fnref9" class="footnote-back">↩︎</a></p></li>
<li id="fn10"><p>To use <code>survey</code> to adjust for pair
membership, one can use the following code to specify the survey design
to be used with <code>svyglm()</code>:
<code>svydesign(ids = ~subclass, weights = ~weights, data = md)</code>
where <code>md</code> is the output of <code><a href="../reference/match.data.html">match.data()</a></code>. After
<code>svyglm()</code>, <code><a href="https://vincentarelbundock.github.io/marginaleffects/reference/comparisons.html" class="external-link">comparisons()</a></code> can be used, and the
<code>vcov</code> argument does not need to be specified.<a href="#fnref10" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Daniel Ho, Kosuke Imai, Gary King, Elizabeth Stuart, Noah Greifer.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
